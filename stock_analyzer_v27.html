<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clarity — Equity Research for Everyone</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: #2a2a3d;
    --accent: #c8f04a;
    --accent2: #4af0c8;
    --danger: #f04a6e;
    --text: #e8e8f0;
    --muted: #6b6b8a;
    --gold: #f0c84a;
  }

  html { scroll-behavior: smooth; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(200,240,74,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(200,240,74,0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  /* Glow orbs */
  .orb {
    position: fixed;
    border-radius: 50%;
    filter: blur(120px);
    pointer-events: none;
    z-index: 0;
    opacity: 0.15;
  }
  .orb-1 { width: 600px; height: 600px; background: var(--accent); top: -200px; right: -200px; animation: float1 8s ease-in-out infinite; }
  .orb-2 { width: 400px; height: 400px; background: var(--accent2); bottom: 100px; left: -100px; animation: float2 10s ease-in-out infinite; }

  @keyframes float1 { 0%,100% { transform: translate(0,0); } 50% { transform: translate(-30px, 40px); } }
  @keyframes float2 { 0%,100% { transform: translate(0,0); } 50% { transform: translate(20px, -30px); } }

  /* Nav */
  nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    padding: 20px 48px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(10,10,15,0.8);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: 900;
    letter-spacing: -0.02em;
    color: var(--text);
  }
  .logo span { color: var(--accent); }

  .nav-tabs {
    display: flex;
    gap: 4px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 3px;
  }
  .nav-tab {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    background: transparent;
    border: none;
    color: var(--muted);
    padding: 7px 16px;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .nav-tab:hover { color: var(--text); }
  .nav-tab.active {
    background: var(--accent);
    color: #0a0a0f;
    font-weight: 500;
  }

  /* Page sections */
  .page { display: none; }
  .page.active { display: block; }

  /* Hero */
  .hero {
    position: relative;
    z-index: 1;
    padding: 180px 48px 80px;
    max-width: 1100px;
    margin: 0 auto;
  }

  .hero-eyebrow {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .hero-eyebrow::before {
    content: '';
    display: block;
    width: 32px;
    height: 1px;
    background: var(--accent);
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(3rem, 6vw, 5.5rem);
    font-weight: 900;
    line-height: 1.05;
    letter-spacing: -0.03em;
    margin-bottom: 28px;
  }
  h1 em {
    font-style: italic;
    color: var(--accent);
  }

  .hero-sub {
    font-size: 1.1rem;
    color: var(--muted);
    max-width: 540px;
    line-height: 1.7;
    margin-bottom: 56px;
    font-weight: 300;
  }

  /* Search bar */
  .search-wrapper {
    display: flex;
    gap: 0;
    max-width: 600px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: visible;
    transition: border-color 0.2s, box-shadow 0.2s;
    position: relative;
  }
  /* Clip only the visible bar parts, not the dropdown */
  .search-wrapper > .ticker-label,
  .search-wrapper > .analyze-btn {
    border-radius: 0;
  }
  .search-wrapper > .ticker-label:first-child { border-radius: 4px 0 0 4px; }
  .search-wrapper > .analyze-btn:last-child { border-radius: 0 4px 4px 0; }
  .search-wrapper:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(200,240,74,0.1);
  }

  .ticker-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    padding: 0 16px;
    display: flex;
    align-items: center;
    border-right: 1px solid var(--border);
    white-space: nowrap;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .search-container { flex: 1; position: relative; }

  #ticker-input {
    width: 100%;
    background: transparent;
    border: none;
    outline: none;
    padding: 18px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 1.1rem;
    color: var(--text);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  #ticker-input::placeholder { color: var(--muted); text-transform: none; letter-spacing: 0; font-size: 0.95rem; }

  .analyze-btn {
    background: var(--accent);
    color: #0a0a0f;
    border: none;
    padding: 18px 28px;
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    white-space: nowrap;
  }
  .analyze-btn:hover { background: #d9ff55; }
  .analyze-btn:active { transform: scale(0.98); }
  .analyze-btn:disabled { background: var(--muted); cursor: not-allowed; }

  .quick-picks {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .quick-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .quick-chip {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    padding: 5px 12px;
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.08em;
    background: transparent;
  }
  .quick-chip:hover { border-color: var(--accent); color: var(--accent); }

  /* Results */
  #results {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 48px 80px;
    display: none;
  }

  .divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
    margin-bottom: 48px;
  }

  /* Stock header */
  .stock-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 40px;
    flex-wrap: wrap;
    gap: 24px;
  }

  .stock-name-block .ticker {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.2em;
    color: var(--accent);
    margin-bottom: 6px;
    text-transform: uppercase;
  }
  .stock-name-block h2 {
    font-family: 'Playfair Display', serif;
    font-size: 2.4rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }
  .stock-name-block .sector-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-top: 6px;
  }

  /* Conviction score */
  .conviction-block {
    text-align: right;
  }
  .conviction-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  .conviction-score {
    font-family: 'Playfair Display', serif;
    font-size: 4rem;
    font-weight: 900;
    line-height: 1;
    color: var(--accent);
  }
  .conviction-score.medium { color: var(--gold); }
  .conviction-score.low { color: var(--danger); }
  .conviction-verdict {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-top: 4px;
  }

  /* Key metrics bar */
  .metrics-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1px;
    background: var(--border);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 40px;
  }
  .metric-cell {
    background: var(--surface);
    padding: 20px 24px;
    transition: background 0.2s;
  }
  .metric-cell:hover { background: var(--surface2); }
  .metric-name {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  .metric-value {
    font-family: 'DM Mono', monospace;
    font-size: 1.2rem;
    font-weight: 500;
    color: var(--text);
  }
  .metric-value.positive { color: var(--accent); }
  .metric-value.negative { color: var(--danger); }
  .metric-delta {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    margin-top: 4px;
  }

  /* Analysis grid */
  .analysis-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  @media (max-width: 768px) {
    .analysis-grid { grid-template-columns: 1fr; }
    nav { padding: 16px 24px; }
    .hero, #results { padding-left: 24px; padding-right: 24px; }
    h1 { font-size: 2.5rem; }
    .stock-header { flex-direction: column; }
    .conviction-block { text-align: left; }
  }

  .analysis-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 28px;
    transition: border-color 0.2s;
    animation: fadeUp 0.5s ease forwards;
    opacity: 0;
  }
  .analysis-card:hover { border-color: rgba(200,240,74,0.3); }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .card-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-label.danger { color: var(--danger); }
  .card-label.gold { color: var(--gold); }
  .card-label.teal { color: var(--accent2); }

  .card-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .card-content {
    font-size: 0.92rem;
    line-height: 1.75;
    color: #b8b8cc;
    font-weight: 300;
  }

  /* Risk/reward bars */
  .rr-item {
    margin-bottom: 20px;
  }
  .rr-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  .rr-name {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    color: var(--text);
  }
  .rr-score {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--muted);
  }
  .rr-bar-bg {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .rr-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .fill-reward { background: var(--accent); }
  .fill-risk { background: var(--danger); }
  .fill-neutral { background: var(--gold); }

  /* Plain English section */
  .plain-english {
    grid-column: 1 / -1;
    background: var(--surface);
    border: 1px solid var(--accent);
    border-radius: 4px;
    padding: 28px;
    animation: fadeUp 0.5s ease 0.3s forwards;
    opacity: 0;
  }

  .pe-quote {
    font-family: 'Playfair Display', serif;
    font-size: 1.05rem;
    font-style: italic;
    line-height: 1.7;
    color: var(--text);
    border-left: 3px solid var(--accent);
    padding-left: 20px;
    margin-top: 16px;
  }

  /* Macro context */
  .macro-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 20px 28px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 24px;
    flex-wrap: wrap;
    animation: fadeUp 0.5s ease 0.1s forwards;
    opacity: 0;
  }
  .macro-item {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .macro-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .macro-text {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    letter-spacing: 0.05em;
  }
  .macro-text strong {
    color: var(--text);
    font-weight: 500;
  }

  /* Loading */
  .loading {
    display: none;
    text-align: center;
    padding: 60px 0;
  }
  .loading-ring {
    width: 48px;
    height: 48px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 20px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }
  .loading-steps {
    margin-top: 12px;
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
  }

  /* Footer note */
  .disclaimer {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    text-align: center;
    padding: 24px 48px;
    border-top: 1px solid var(--border);
    letter-spacing: 0.05em;
    position: relative;
    z-index: 1;
  }

  /* Stagger animation delays */
  .analysis-card:nth-child(1) { animation-delay: 0.1s; }
  .analysis-card:nth-child(2) { animation-delay: 0.2s; }
  .analysis-card:nth-child(3) { animation-delay: 0.25s; }
  .analysis-card:nth-child(4) { animation-delay: 0.3s; }

  /* Error state */
  .error-msg {
    background: rgba(240,74,110,0.08);
    border: 1px solid var(--danger);
    border-radius: 4px;
    padding: 16px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--danger);
    display: none;
    margin-top: 12px;
  }

  /* Autocomplete */
  .autocomplete-dropdown {
    position: absolute;
    top: calc(100% + 2px);
    left: 0;
    right: 0;
    background: #1a1a26;
    border: 1px solid var(--accent);
    border-radius: 0 0 4px 4px;
    z-index: 9999;
    max-height: 260px;
    overflow-y: auto;
    display: none;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  .autocomplete-item {
    padding: 10px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid rgba(42,42,61,0.5);
    transition: background 0.1s;
  }
  .autocomplete-item:hover, .autocomplete-item.active { background: var(--surface2); }
  .autocomplete-ticker {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--accent);
    min-width: 52px;
    letter-spacing: 0.05em;
  }
  .autocomplete-name {
    font-size: 0.82rem;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .autocomplete-sector {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: #4a4a6a;
    margin-left: auto;
    white-space: nowrap;
  }

  /* Report timestamp */
  .report-meta {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    margin-bottom: 32px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }
  .report-meta-dot { color: var(--border); }

  /* PDF export button */
  .export-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 6px 14px;
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: auto;
  }
  .export-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* Tooltips */
  .tooltip-wrap { position: relative; cursor: help; }
  .tooltip-box {
    display: none;
    position: absolute;
    bottom: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    width: 260px;
    background: #1a1a2e;
    border: 1px solid var(--accent);
    border-radius: 6px;
    padding: 14px 16px;
    z-index: 500;
    pointer-events: none;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  .tooltip-box::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: var(--accent);
  }
  .tooltip-wrap:hover .tooltip-box { display: block; }
  .tooltip-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 6px;
  }
  .tooltip-body {
    font-size: 0.8rem;
    color: #c8c8e0;
    line-height: 1.6;
    font-weight: 300;
  }
  .tooltip-context {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
    line-height: 1.5;
  }

  /* PDF print styles */
  @media print {
    @page { margin: 0; size: 8.5in 11in; }
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    body > *:not(#pdf-report) { display: none !important; }
    #pdf-report {
      display: block !important;
      position: static !important;
      width: 816px !important;
      height: 1056px !important;
      overflow: hidden !important;
      background: white !important;
    }
  }
  /* Portfolio rows */
  .portfolio-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .remove-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 32px;
    height: 32px;
    border-radius: 2px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .remove-btn:hover { border-color: var(--danger); color: var(--danger); }

  /* Portfolio results */
  .portfolio-score-block {
    display: flex;
    align-items: center;
    gap: 48px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 32px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }
  .portfolio-grade {
    font-family: 'Playfair Display', serif;
    font-size: 5rem;
    font-weight: 900;
    line-height: 1;
    color: var(--accent);
  }
  .portfolio-grade.medium { color: var(--gold); }
  .portfolio-grade.low { color: var(--danger); }
  .holding-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 20px 24px;
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 10px;
    transition: border-color 0.2s;
  }
  .holding-card:hover { border-color: rgba(200,240,74,0.3); }
  .holding-card.weak { border-left: 3px solid var(--danger); }
  .holding-card.strong { border-left: 3px solid var(--accent); }
</style>
</head>
<body>

<!-- API Key Setup Banner -->
<div id="api-setup" style="display:none; position:fixed; inset:0; z-index:999; background:rgba(10,10,15,0.97); backdrop-filter:blur(10px); align-items:center; justify-content:center; flex-direction:column; padding:24px;">
  <div style="max-width:480px; width:100%; background:#12121a; border:1px solid #2a2a3d; border-radius:6px; padding:40px;">
    <div style="font-family:'DM Mono',monospace; font-size:0.65rem; letter-spacing:0.2em; text-transform:uppercase; color:#c8f04a; margin-bottom:16px;">First Time Setup</div>
    <div style="font-family:'Playfair Display',serif; font-size:1.8rem; font-weight:700; color:#e8e8f0; margin-bottom:12px;">Enter your API Key</div>
    <div style="font-family:'DM Sans',sans-serif; font-size:0.88rem; color:#6b6b8a; line-height:1.6; margin-bottom:28px;">
      Paste your Anthropic API key below. It will be saved on your computer and you'll never need to enter it again.
    </div>
    <input 
      type="password" 
      id="api-key-input"
      placeholder="sk-ant-api03-..."
      onkeydown="if(event.key==='Enter') saveApiKey()"
      style="width:100%; background:#0a0a0f; border:1px solid #2a2a3d; border-radius:4px; padding:14px 16px; font-family:'DM Mono',monospace; font-size:0.85rem; color:#e8e8f0; outline:none; margin-bottom:12px;"
    />
    <div id="api-error" style="color:#f04a6e; font-family:'DM Mono',monospace; font-size:0.72rem; margin-bottom:12px; display:none;">Please enter a valid API key (starts with sk-ant-)</div>
    <button onclick="saveApiKey()" style="width:100%; background:#c8f04a; color:#0a0a0f; border:none; padding:14px; font-family:'DM Mono',monospace; font-size:0.8rem; font-weight:500; letter-spacing:0.12em; text-transform:uppercase; cursor:pointer; border-radius:4px;">
      Save & Continue →
    </button>
    <div style="font-family:'DM Mono',monospace; font-size:0.65rem; color:#6b6b8a; margin-top:16px; text-align:center;">
      Your key is stored locally on your Mac only. Never shared.
    </div>
  </div>
</div>

<div class="orb orb-1"></div>
<div class="orb orb-2"></div>

<nav>
  <div class="logo">Clarity<span>.</span></div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('analyze')" id="tab-analyze">Stock Analysis</button>
    <button class="nav-tab" onclick="switchTab('discover')" id="tab-discover">Discover</button>
    <button class="nav-tab" onclick="switchTab('portfolio')" id="tab-portfolio">Portfolio</button>
    <button class="nav-tab" onclick="switchTab('about')" id="tab-about">About</button>
  </div>
  <button onclick="document.getElementById('api-setup').style.display='flex'" style="font-family:'DM Mono',monospace;font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;background:transparent;border:1px solid var(--border);color:var(--muted);padding:5px 12px;border-radius:2px;cursor:pointer;">⚙ API Key</button>
</nav>

<div id="page-analyze" class="page active">
<section class="hero">
  <div class="hero-eyebrow">AI-Powered Stock Analysis</div>
  <h1>Wall Street research.<br><em>For everyone.</em></h1>
  <p class="hero-sub">Enter any stock ticker and get the same quality of analysis that hedge funds pay thousands for — in plain English and in analyst-grade detail. Reward vs. risk, front and center.</p>

  <div class="search-wrapper">
    <div class="ticker-label">Ticker</div>
    <div class="search-container">
      <input type="text" id="ticker-input" placeholder="e.g. AAPL, NVDA, TSLA, or company name" maxlength="20" autocomplete="off" />
    </div>
    <button class="analyze-btn" id="analyze-btn" onclick="runAnalysis()">Analyze →</button>
    <div class="autocomplete-dropdown" id="autocomplete-dropdown"></div>
  </div>
  <div class="error-msg" id="error-msg"></div>

  <div class="quick-picks">
    <span class="quick-label">Try:</span>
    <button class="quick-chip" onclick="quickPick('AAPL')">AAPL</button>
    <button class="quick-chip" onclick="quickPick('NVDA')">NVDA</button>
    <button class="quick-chip" onclick="quickPick('MSFT')">MSFT</button>
    <button class="quick-chip" onclick="quickPick('TSLA')">TSLA</button>
    <button class="quick-chip" onclick="quickPick('AMZN')">AMZN</button>
  </div>

  <!-- Compare Mode -->
  <div style="margin-top:20px;max-width:600px;">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
      <button onclick="toggleCompare()" id="compare-toggle" class="quick-chip" style="border-color:var(--accent2);color:var(--accent2);">⇄ Compare Mode</button>
      <span style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);">Analyze two stocks head-to-head</span>
    </div>
    <div id="compare-panel" style="display:none;margin-top:8px;">
      <div class="search-wrapper" style="margin-bottom:0;">
        <div class="ticker-label">vs.</div>
        <div class="search-container">
          <input type="text" id="compare-input" placeholder="Enter second ticker (e.g. AMD)" maxlength="20" autocomplete="off" style="width:100%;background:transparent;border:none;outline:none;padding:14px 16px;font-family:'DM Mono',monospace;font-size:1rem;color:var(--text);text-transform:uppercase;letter-spacing:0.08em;" />
        </div>
        <button class="analyze-btn" onclick="runCompare()" style="background:var(--accent2);color:#0a0a0f;">Compare →</button>
      </div>
    </div>
  </div>

  <!-- Watchlist -->
  <div id="watchlist-section" style="margin-top:28px;max-width:700px;display:none;">
    <div style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:12px;">Your Watchlist</div>
    <div id="watchlist-items" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
  </div>
</section>

<!-- Loading -->
<div class="loading" id="loading">
  <div class="loading-ring"></div>
  <div class="loading-text">Pulling financial data</div>
  <div class="loading-steps" id="loading-step">Fetching price & valuation metrics...</div>
</div>

<!-- Results -->
<div id="results">
  <div class="divider"></div>

  <!-- Report meta -->
  <div class="report-meta" id="report-meta">
    <span id="report-timestamp"></span>
    <span class="report-meta-dot">·</span>
    <span>Powered by Clarity AI</span>
    <span class="report-meta-dot">·</span>
    <span>Not financial advice</span>
    <button class="export-btn" onclick="toggleWatchlist()" id="watchlist-btn" style="background:transparent;border-color:var(--accent2);color:var(--accent2);">+ Watchlist</button>
    <button class="export-btn" onclick="exportPDF()">⬇ Export PDF</button>
  </div>

  <!-- Stock header -->
  <div class="stock-header">
    <div class="stock-name-block">
      <div class="ticker" id="res-ticker"></div>
      <h2 id="res-name"></h2>
      <div class="sector-tag" id="res-sector"></div>
    </div>
    <div class="conviction-block">
      <div class="conviction-label">AI Conviction Score</div>
      <div class="conviction-score" id="res-conviction"></div>
      <div class="conviction-verdict" id="res-verdict"></div>
    </div>
  </div>

  <!-- Metrics bar -->
  <div class="metrics-bar" id="metrics-bar"></div>

  <!-- Macro context -->
  <div class="macro-bar" id="macro-bar"></div>

  <!-- Analysis grid -->
  <div class="analysis-grid" id="analysis-grid"></div>
</div>

<div class="disclaimer">
  Clarity is an educational tool built for learning purposes. Not financial advice. Always do your own research before investing.
</div>
</div><!-- end page-analyze -->

<!-- ── PORTFOLIO PAGE ── -->
<div id="page-portfolio" class="page">
  <section class="hero" style="padding-bottom:40px;">
    <div class="hero-eyebrow">Portfolio Analyzer</div>
    <h1>Your portfolio.<br><em>Analyzed.</em></h1>
    <p class="hero-sub">Enter your holdings below. The AI will score your overall portfolio, flag your weakest positions, and suggest specific moves to improve it.</p>

    <div id="portfolio-holdings" style="max-width:600px;margin-bottom:16px;">
      <div class="portfolio-row" id="holding-0">
        <div class="search-wrapper" style="flex:1;">
          <div class="ticker-label">Ticker</div>
          <div class="search-container">
            <input type="text" class="holding-ticker" placeholder="e.g. AAPL" maxlength="10" autocomplete="off" style="width:100%;background:transparent;border:none;outline:none;padding:14px 16px;font-family:'DM Mono',monospace;font-size:1rem;color:var(--text);text-transform:uppercase;letter-spacing:0.08em;" />
          </div>
        </div>
        <div class="search-wrapper" style="width:140px;">
          <div class="ticker-label">Shares</div>
          <input type="number" class="holding-shares" placeholder="0" min="0" style="flex:1;width:80px;background:transparent;border:none;outline:none;padding:14px 12px;font-family:'DM Mono',monospace;font-size:1rem;color:var(--text);" />
        </div>
        <button onclick="removeHolding(0)" class="remove-btn" style="visibility:hidden;">✕</button>
      </div>
    </div>

    <div style="display:flex;gap:12px;max-width:600px;margin-bottom:32px;">
      <button onclick="addHolding()" class="quick-chip" style="border-color:var(--accent);color:var(--accent);">+ Add Stock</button>
      <button onclick="runPortfolioAnalysis()" class="analyze-btn" style="border-radius:4px;padding:10px 24px;">Analyze Portfolio →</button>
    </div>
    <div class="error-msg" id="portfolio-error"></div>
  </section>

  <!-- Portfolio Loading -->
  <div class="loading" id="portfolio-loading">
    <div class="loading-ring"></div>
    <div class="loading-text">Analyzing your portfolio</div>
    <div class="loading-steps" id="portfolio-loading-step">Fetching data for all holdings...</div>
  </div>

  <!-- Portfolio Results -->
  <div id="portfolio-results" style="display:none;position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:0 48px 80px;">
    <div class="divider"></div>
    <div id="portfolio-content"></div>
  </div>
</div><!-- end page-portfolio -->

<!-- ── ABOUT PAGE ── -->
<div id="page-about" class="page">
  <section class="hero" style="max-width:800px;padding-bottom:80px;">
    <div class="hero-eyebrow">About Clarity</div>
    <h1>Built from<br><em>personal experience.</em></h1>

    <div style="max-width:640px;margin-top:40px;">
      <div style="font-size:1.05rem;color:#b8b8cc;line-height:1.85;font-weight:300;margin-bottom:32px;">
        Financial literacy is one of the most overlooked problems facing young investors today. Most people entering the market for the first time don't lack ambition or curiosity — they lack access. The research tools, analytical frameworks, and institutional knowledge that professional investors rely on have never been built for everyone else.
      </div>
      <div style="font-size:1.05rem;color:#b8b8cc;line-height:1.85;font-weight:300;margin-bottom:32px;">
        I built Clarity because I believe the same quality of equity research that hedge funds pay thousands of dollars for should be accessible to everyone. Not watered down. Not oversimplified. The real thing — in plain English.
      </div>
      <div style="font-size:1.05rem;color:#b8b8cc;line-height:1.85;font-weight:300;margin-bottom:48px;">
        I'm a freshman studying Economics at Indiana University, with a minor in Business at the Kelley School of Business. I'm fascinated by markets, technology, and where the two intersect. Clarity is my attempt to put those interests to work on a real problem.
      </div>

      <div style="border-top:1px solid var(--border);padding-top:40px;">
        <div class="hero-eyebrow" style="margin-bottom:24px;">What Clarity Does</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:20px;">
            <div style="font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--accent);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:10px;">Stock Analysis</div>
            <div style="font-size:0.88rem;color:#8888aa;line-height:1.65;font-weight:300;">Enter any ticker and get an AI-generated analyst report — valuation, reward vs. risk, macro context, and a plain English summary.</div>
          </div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:20px;">
            <div style="font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--accent);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:10px;">Portfolio Analysis</div>
            <div style="font-size:0.88rem;color:#8888aa;line-height:1.65;font-weight:300;">Add your full portfolio and let the AI score it, identify weak spots, and suggest specific moves to improve your risk-reward profile.</div>
          </div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:20px;">
            <div style="font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--accent);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:10px;">Conviction Scoring</div>
            <div style="font-size:0.88rem;color:#8888aa;line-height:1.65;font-weight:300;">Every report includes a 1–10 conviction score built from five weighted factors: valuation, quality, growth, risk, and macro sensitivity.</div>
          </div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:20px;">
            <div style="font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--accent);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:10px;">Professional PDF Export</div>
            <div style="font-size:0.88rem;color:#8888aa;line-height:1.65;font-weight:300;">Export any report as a clean, one-page PDF formatted like a real Goldman Sachs or Morgan Stanley research note.</div>
          </div>
        </div>
      </div>

      <!-- How Clarity Works -->
      <div style="border-top:1px solid var(--border);padding-top:40px;margin-top:40px;">
        <div class="hero-eyebrow" style="margin-bottom:24px;">How Clarity Works</div>
        <div style="display:grid;gap:12px;">
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:20px;display:flex;gap:20px;align-items:flex-start;">
            <div style="font-family:'DM Mono',monospace;font-size:1rem;color:var(--accent);flex-shrink:0;margin-top:2px;">01</div>
            <div>
              <div style="font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--accent);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:8px;">Real Data, Pulled Fresh</div>
              <div style="font-size:0.88rem;color:#8888aa;line-height:1.65;font-weight:300;">Every analysis starts with live market data from Yahoo Finance — current price, P/E ratio, revenue growth, profit margins, beta, free cash flow, and analyst price targets. Nothing is cached or fabricated. The numbers you see reflect what the market sees right now.</div>
            </div>
          </div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:20px;display:flex;gap:20px;align-items:flex-start;">
            <div style="font-family:'DM Mono',monospace;font-size:1rem;color:var(--accent);flex-shrink:0;margin-top:2px;">02</div>
            <div>
              <div style="font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--accent);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:8px;">Five-Factor Conviction Model</div>
              <div style="font-size:0.88rem;color:#8888aa;line-height:1.65;font-weight:300;">The AI scores every stock across five weighted dimensions — valuation (30%), quality (25%), growth (20%), risk (15%), and macro sensitivity (10%). Each factor gets an explicit 1–10 score with reasoning, then combines into a single conviction score. Same framework a junior analyst at a hedge fund would apply, applied consistently every time.</div>
            </div>
          </div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:20px;display:flex;gap:20px;align-items:flex-start;">
            <div style="font-family:'DM Mono',monospace;font-size:1rem;color:var(--gold);flex-shrink:0;margin-top:2px;">03</div>
            <div>
              <div style="font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--gold);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:8px;">What the AI Doesn't Do</div>
              <div style="font-size:0.88rem;color:#8888aa;line-height:1.65;font-weight:300;">Clarity doesn't predict the future or know about breaking news. It applies a structured analytical framework to the data it has — no more, no less. Every report is a starting point for your own research, not a buy or sell recommendation. Use it to ask better questions, not to skip them.</div>
            </div>
          </div>
        </div>
      </div>

      <div style="border-top:1px solid var(--border);padding-top:40px;margin-top:40px;">
        <div class="hero-eyebrow" style="margin-bottom:16px;">Connect</div>
        <div style="font-size:0.9rem;color:var(--muted);font-family:'DM Mono',monospace;">
          <a href="https://github.com/tyjwhite42" target="_blank" style="color:var(--accent);text-decoration:none;">github.com/tyjwhite42</a>
          <span style="margin:0 12px;color:var(--border)">·</span>
          Indiana University — Class of 2028
        </div>
      </div>
    </div>
  </section>
</div><!-- end page-about -->

<!-- ── SCREENER PAGE ── -->
<div id="page-discover" class="page">
  <section class="hero" style="padding-bottom:40px;">
    <div class="hero-eyebrow">Discover</div>
    <h1>Find your next<br><em>opportunity.</em></h1>
    <p class="hero-sub">Filter stocks by sector, valuation, and growth profile. The AI screens your results and flags the most compelling setups.</p>

    <div style="max-width:700px;margin-top:32px;">
      <!-- Filters -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
        <div class="search-wrapper" style="flex-direction:column;align-items:flex-start;padding:0;">
          <div class="ticker-label" style="margin-bottom:4px;">Sector</div>
          <select id="screen-sector" style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:12px 14px;font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--text);outline:none;">
            <option value="">All Sectors</option>
            <option>Technology</option>
            <option>Healthcare</option>
            <option>Financials</option>
            <option>Consumer Cyclical</option>
            <option>Consumer Staples</option>
            <option>Energy</option>
            <option>Industrials</option>
            <option>Communication</option>
            <option>Real Estate</option>
            <option>Utilities</option>
          </select>
        </div>
        <div class="search-wrapper" style="flex-direction:column;align-items:flex-start;padding:0;">
          <div class="ticker-label" style="margin-bottom:4px;">Valuation</div>
          <select id="screen-valuation" style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:12px 14px;font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--text);outline:none;">
            <option value="">Any</option>
            <option value="value">Value (P/E &lt; 15)</option>
            <option value="growth">Growth (P/E 15–40)</option>
            <option value="premium">Premium (P/E &gt; 40)</option>
          </select>
        </div>
        <div class="search-wrapper" style="flex-direction:column;align-items:flex-start;padding:0;">
          <div class="ticker-label" style="margin-bottom:4px;">Market Cap</div>
          <select id="screen-cap" style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:12px 14px;font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--text);outline:none;">
            <option value="">Any</option>
            <option value="mega">Mega Cap (&gt;$200B)</option>
            <option value="large">Large Cap ($10B–$200B)</option>
            <option value="mid">Mid Cap ($2B–$10B)</option>
          </select>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
        <div class="search-wrapper" style="flex-direction:column;align-items:flex-start;padding:0;">
          <div class="ticker-label" style="margin-bottom:4px;">Risk Profile</div>
          <select id="screen-risk" style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:12px 14px;font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--text);outline:none;">
            <option value="">Any</option>
            <option value="low">Low Risk (Beta &lt; 0.8)</option>
            <option value="medium">Medium Risk (Beta 0.8–1.3)</option>
            <option value="high">High Risk (Beta &gt; 1.3)</option>
          </select>
        </div>
        <div class="search-wrapper" style="flex-direction:column;align-items:flex-start;padding:0;">
          <div class="ticker-label" style="margin-bottom:4px;">Analyst Sentiment</div>
          <select id="screen-sentiment" style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:12px 14px;font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--text);outline:none;">
            <option value="">Any</option>
            <option value="bullish">Bullish</option>
            <option value="neutral">Neutral</option>
            <option value="bearish">Bearish</option>
          </select>
        </div>
      </div>
      <button onclick="runDiscover()" class="analyze-btn" style="border-radius:4px;padding:12px 32px;">Discover Stocks →</button>
    </div>
    <div class="error-msg" id="discover-error"></div>
  </section>

  <div class="loading" id="discover-loading" style="display:none;">
    <div class="loading-ring"></div>
    <div class="loading-text">Screening the market</div>
    <div class="loading-steps" id="discover-loading-step">Applying filters...</div>
  </div>

  <div id="discover-results" style="display:none;max-width:1100px;margin:0 auto;padding:0 48px 80px;">
    <div class="divider"></div>
    <div id="discover-content"></div>
  </div>
</div><!-- end page-discover -->

<!-- ── COMPARE RESULTS (inside analyze tab, shown dynamically) ── -->
<div id="compare-results" style="display:none;max-width:1100px;margin:0 auto;padding:0 48px 80px;position:relative;z-index:1;">
  <div class="divider"></div>
  <div style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--accent2);letter-spacing:0.2em;text-transform:uppercase;margin-bottom:24px;">Head-to-Head Comparison</div>
  <div id="compare-content"></div>
</div>

<script>
  let ANTHROPIC_API_KEY = localStorage.getItem('clarity_api_key') || '';

  // ── TAB SWITCHING ──
  function switchTab(tab) {
    ['analyze','discover','portfolio','about'].forEach(t => {
      document.getElementById('page-'+t).classList.toggle('active', t === tab);
      document.getElementById('tab-'+t).classList.toggle('active', t === tab);
    });
    window.scrollTo(0, 0);
  }

  // ── WATCHLIST ──
  let watchlist = JSON.parse(localStorage.getItem('clarity_watchlist') || '[]');
  let currentTicker = '';

  function renderWatchlist() {
    const el = document.getElementById('watchlist-items');
    const section = document.getElementById('watchlist-section');
    if (!watchlist.length) { section.style.display = 'none'; return; }
    section.style.display = 'block';
    el.innerHTML = watchlist.map(t => `
      <div style="display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:6px 12px;">
        <button onclick="quickPick('${t}')" style="font-family:'DM Mono',monospace;font-size:0.78rem;color:var(--accent);background:none;border:none;cursor:pointer;letter-spacing:0.08em;">${t}</button>
        <button onclick="removeFromWatchlist('${t}')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.7rem;padding:0 2px;">✕</button>
      </div>
    `).join('');
  }

  function toggleWatchlist() {
    if (!currentTicker) return;
    const btn = document.getElementById('watchlist-btn');
    if (watchlist.includes(currentTicker)) {
      removeFromWatchlist(currentTicker);
    } else {
      watchlist.push(currentTicker);
      localStorage.setItem('clarity_watchlist', JSON.stringify(watchlist));
      btn.textContent = '✓ Watchlisted';
      btn.style.borderColor = 'var(--accent)';
      btn.style.color = 'var(--accent)';
      renderWatchlist();
    }
  }

  function removeFromWatchlist(ticker) {
    watchlist = watchlist.filter(t => t !== ticker);
    localStorage.setItem('clarity_watchlist', JSON.stringify(watchlist));
    if (currentTicker === ticker) {
      const btn = document.getElementById('watchlist-btn');
      btn.textContent = '+ Watchlist';
      btn.style.borderColor = 'var(--accent2)';
      btn.style.color = 'var(--accent2)';
    }
    renderWatchlist();
  }

  function updateWatchlistBtn(ticker) {
    const btn = document.getElementById('watchlist-btn');
    if (watchlist.includes(ticker)) {
      btn.textContent = '✓ Watchlisted';
      btn.style.borderColor = 'var(--accent)';
      btn.style.color = 'var(--accent)';
    } else {
      btn.textContent = '+ Watchlist';
      btn.style.borderColor = 'var(--accent2)';
      btn.style.color = 'var(--accent2)';
    }
  }

  // ── COMPARE MODE ──
  let compareMode = false;

  function toggleCompare() {
    compareMode = !compareMode;
    const panel = document.getElementById('compare-panel');
    const btn = document.getElementById('compare-toggle');
    panel.style.display = compareMode ? 'block' : 'none';
    btn.style.borderColor = compareMode ? 'var(--accent2)' : '';
    btn.style.background = compareMode ? 'rgba(74,240,200,0.1)' : '';
  }

  async function runCompare() {
    const ticker1 = document.getElementById('ticker-input').value.trim().toUpperCase();
    const ticker2 = document.getElementById('compare-input').value.trim().toUpperCase();
    if (!ticker1 || !ticker2) {
      alert('Please enter both tickers to compare.');
      return;
    }

    document.getElementById('compare-results').style.display = 'none';
    document.getElementById('results').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loading-step').textContent = `Analyzing ${ticker1} vs ${ticker2}...`;

    try {
      const [r1, r2] = await Promise.all([
        fetchAndAnalyze(ticker1),
        fetchAndAnalyze(ticker2),
      ]);

      document.getElementById('loading').style.display = 'none';
      renderCompare(ticker1, r1, ticker2, r2);
    } catch(err) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-msg').textContent = err.message;
      document.getElementById('error-msg').style.display = 'block';
    }
  }

  function renderCompare(t1, r1, t2, r2) {
    const d1 = r1.stockData, a1 = r1.analysis;
    const d2 = r2.stockData, a2 = r2.analysis;
    const cm1 = a1.conviction_model, cm2 = a2.conviction_model;

    const winColor = '#c8f04a';
    const loseColor = '#6b6b8a';

    function better(v1, v2, higherIsBetter = true) {
      if (v1 == null || v2 == null) return [loseColor, loseColor];
      return higherIsBetter
        ? [v1 >= v2 ? winColor : loseColor, v2 >= v1 ? winColor : loseColor]
        : [v1 <= v2 ? winColor : loseColor, v2 <= v1 ? winColor : loseColor];
    }

    const scoreColors = better(cm1.conviction_score, cm2.conviction_score);

    const content = document.getElementById('compare-content');
    content.innerHTML = `
      <!-- Header row -->
      <div style="display:grid;grid-template-columns:1fr 80px 1fr;gap:16px;align-items:center;margin-bottom:32px;">
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--accent);letter-spacing:0.1em;">${t1}</div>
          <div style="font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;color:var(--text);margin:4px 0;">${d1.name}</div>
          <div style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);">${d1.sector}</div>
        </div>
        <div style="text-align:center;font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);">VS</div>
        <div style="text-align:right;">
          <div style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--accent);letter-spacing:0.1em;">${t2}</div>
          <div style="font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;color:var(--text);margin:4px 0;">${d2.name}</div>
          <div style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);">${d2.sector}</div>
        </div>
      </div>

      <!-- Conviction scores -->
      <div style="display:grid;grid-template-columns:1fr 120px 1fr;gap:16px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:24px;margin-bottom:16px;">
        <div>
          <div style="font-family:'Playfair Display',serif;font-size:3rem;font-weight:900;color:${scoreColors[0]};">${cm1.conviction_score}<span style="font-size:1.2rem;color:var(--muted)">/10</span></div>
          <div style="font-family:'DM Mono',monospace;font-size:0.8rem;color:${scoreColors[0]};margin-top:4px;">${cm1.verdict}</div>
        </div>
        <div style="text-align:center;font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);letter-spacing:0.15em;text-transform:uppercase;">Conviction</div>
        <div style="text-align:right;">
          <div style="font-family:'Playfair Display',serif;font-size:3rem;font-weight:900;color:${scoreColors[1]};">${cm2.conviction_score}<span style="font-size:1.2rem;color:var(--muted)">/10</span></div>
          <div style="font-family:'DM Mono',monospace;font-size:0.8rem;color:${scoreColors[1]};margin-top:4px;">${cm2.verdict}</div>
        </div>
      </div>

      <!-- Metrics comparison table -->
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;margin-bottom:16px;overflow:hidden;">
        ${[
          ['Price', d1.currentPrice ? '$'+d1.currentPrice.toFixed(2) : 'N/A', d2.currentPrice ? '$'+d2.currentPrice.toFixed(2) : 'N/A', null],
          ['Market Cap', formatLargeNumber(d1.marketCap), formatLargeNumber(d2.marketCap), [d1.marketCap, d2.marketCap, true]],
          ['P/E Ratio', d1.peRatio ? d1.peRatio.toFixed(1)+'x' : 'N/A', d2.peRatio ? d2.peRatio.toFixed(1)+'x' : 'N/A', [d1.peRatio, d2.peRatio, false]],
          ['Revenue Growth', d1.revenueGrowth ? pct(d1.revenueGrowth) : 'N/A', d2.revenueGrowth ? pct(d2.revenueGrowth) : 'N/A', [d1.revenueGrowth, d2.revenueGrowth, true]],
          ['Profit Margin', d1.profitMargins ? pct(d1.profitMargins) : 'N/A', d2.profitMargins ? pct(d2.profitMargins) : 'N/A', [d1.profitMargins, d2.profitMargins, true]],
          ['Beta', d1.beta ? d1.beta.toFixed(2) : 'N/A', d2.beta ? d2.beta.toFixed(2) : 'N/A', null],
          ['ROE', d1.returnOnEquity ? pct(d1.returnOnEquity) : 'N/A', d2.returnOnEquity ? pct(d2.returnOnEquity) : 'N/A', [d1.returnOnEquity, d2.returnOnEquity, true]],
          ['Conviction Score', cm1.conviction_score+'/10', cm2.conviction_score+'/10', [cm1.conviction_score, cm2.conviction_score, true]],
        ].map(([label, v1, v2, comp], i) => {
          const colors = comp ? better(comp[0], comp[1], comp[2]) : [loseColor, loseColor];
          const bg = i % 2 === 0 ? 'var(--surface)' : 'var(--surface2)';
          return `
            <div style="display:grid;grid-template-columns:1fr 140px 1fr;padding:12px 20px;background:${bg};align-items:center;">
              <div style="font-family:'DM Mono',monospace;font-size:0.78rem;color:${comp ? colors[0] : 'var(--text)' };font-weight:${comp && colors[0]===winColor ? '500' : '400'}">${v1}</div>
              <div style="text-align:center;font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;">${label}</div>
              <div style="text-align:right;font-family:'DM Mono',monospace;font-size:0.78rem;color:${comp ? colors[1] : 'var(--text)'};font-weight:${comp && colors[1]===winColor ? '500' : '400'}">${v2}</div>
            </div>
          `;
        }).join('')}
      </div>

      <!-- Analyst summaries -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
        <div class="analysis-card" style="opacity:1;animation:none;">
          <div class="card-label">${t1} — Analyst Take</div>
          <div class="card-content">${a1.analyst_summary}</div>
        </div>
        <div class="analysis-card" style="opacity:1;animation:none;">
          <div class="card-label">${t2} — Analyst Take</div>
          <div class="card-content">${a2.analyst_summary}</div>
        </div>
      </div>

      <!-- Plain English -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
        <div style="background:var(--surface);border:1px solid var(--accent);border-radius:4px;padding:24px;">
          <div class="card-label" style="margin-bottom:12px;">${t1} — Plain English</div>
          <div class="pe-quote" style="margin:0;">${a1.plain_english}</div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--accent2);border-radius:4px;padding:24px;">
          <div class="card-label" style="margin-bottom:12px;">${t2} — Plain English</div>
          <div class="pe-quote" style="margin:0;">${a2.plain_english}</div>
        </div>
      </div>

      <!-- Verdict -->
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:24px;text-align:center;">
        <div style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);letter-spacing:0.2em;text-transform:uppercase;margin-bottom:12px;">Bottom Line</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--text);line-height:1.7;">
          ${cm1.conviction_score > cm2.conviction_score
            ? `<strong style="color:var(--accent)">${t1}</strong> scores higher with ${cm1.conviction_score}/10 conviction vs ${t2}'s ${cm2.conviction_score}/10.`
            : cm2.conviction_score > cm1.conviction_score
            ? `<strong style="color:var(--accent)">${t2}</strong> scores higher with ${cm2.conviction_score}/10 conviction vs ${t1}'s ${cm1.conviction_score}/10.`
            : `<strong>${t1}</strong> and <strong>${t2}</strong> are evenly matched at ${cm1.conviction_score}/10 conviction each.`
          }
        </div>
      </div>
    `;

    document.getElementById('compare-results').style.display = 'block';
    document.getElementById('compare-results').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // ── SCREENER ──
  async function runDiscover() {
    const sector = document.getElementById('screen-sector').value;
    const valuation = document.getElementById('screen-valuation').value;
    const cap = document.getElementById('screen-cap').value;
    const risk = document.getElementById('screen-risk').value;
    const sentiment = document.getElementById('screen-sentiment').value;

    const errEl = document.getElementById('discover-error');
    errEl.style.display = 'none';
    document.getElementById('discover-results').style.display = 'none';
    document.getElementById('discover-loading').style.display = 'block';
    document.getElementById('discover-loading-step').textContent = 'Applying filters to stock universe...';

    try {
      // Build filter description for AI
      const filters = [
        sector && `Sector: ${sector}`,
        valuation === 'value' && 'P/E below 15 (value)',
        valuation === 'growth' && 'P/E between 15–40 (growth)',
        valuation === 'premium' && 'P/E above 40 (premium/high-growth)',
        cap === 'mega' && 'Market cap above $200B',
        cap === 'large' && 'Market cap $10B–$200B',
        cap === 'mid' && 'Market cap $2B–$10B',
        risk === 'low' && 'Beta below 0.8 (low volatility)',
        risk === 'medium' && 'Beta 0.8–1.3 (moderate volatility)',
        risk === 'high' && 'Beta above 1.3 (high volatility)',
        sentiment === 'bullish' && 'Bullish analyst sentiment',
        sentiment === 'neutral' && 'Neutral analyst sentiment',
        sentiment === 'bearish' && 'Bearish analyst sentiment',
      ].filter(Boolean);

      const filterDesc = filters.length > 0 ? filters.join(', ') : 'No specific filters (broad screen)';

      document.getElementById('discover-loading-step').textContent = 'AI scanning for matching opportunities...';

      const prompt = `You are an institutional equity research analyst running a stock screen. Based on these filter criteria: ${filterDesc}

Return ONLY valid JSON with no markdown:
{
  "screen_summary": <one sentence describing what type of stocks this screen targets>,
  "results": [
    {
      "ticker": <ticker symbol>,
      "name": <company name>,
      "sector": <sector>,
      "why_it_fits": <one sentence on why this stock matches the screen criteria>,
      "key_metric": <the single most relevant metric for this screen, e.g. "P/E: 12x" or "Revenue Growth: 35%">,
      "conviction": <1-10>,
      "verdict": <"BUY" | "HOLD" | "WATCH">,
      "flag": <"Value Play" | "Growth Compounder" | "Defensive Hold" | "Turnaround" | "Momentum" | "Dividend" | "Speculative">
    }
  ]
}
Return 6–8 real, well-known stocks that genuinely match the criteria. Order by conviction score descending.`;

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': ANTHROPIC_API_KEY,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1200,
          messages: [{ role: 'user', content: prompt }]
        })
      });

      if (!response.ok) throw new Error('Discovery failed. Check your API key.');
      const result = await response.json();
      const text = result.content[0].text.replace(/```json|```/g, '').trim();
      const screen = JSON.parse(text);

      document.getElementById('discover-loading').style.display = 'none';
      renderDiscoverResults(screen, filterDesc);

    } catch(err) {
      document.getElementById('discover-loading').style.display = 'none';
      errEl.textContent = err.message || 'Something went wrong. Please try again.';
      errEl.style.display = 'block';
    }
  }

  function renderDiscoverResults(screen, filterDesc) {
    const content = document.getElementById('discover-content');

    const flagColors = {
      'Value Play': '#c8f04a', 'Growth Compounder': '#4af0c8', 'Defensive Hold': '#f0c84a',
      'Turnaround': '#f08c4a', 'Momentum': '#a04af0', 'Dividend': '#4a8cf0', 'Speculative': '#f04a6e'
    };

    content.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:24px;">
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:6px;">Screen Results · ${screen.results.length} matches</div>
          <div style="font-size:1rem;color:var(--text);font-weight:300;">${screen.screen_summary}</div>
        </div>
        <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);text-align:right;">Filters: ${filterDesc}</div>
      </div>
      <div style="display:grid;gap:10px;">
        ${screen.results.map(r => {
          const verdictColor = r.verdict === 'BUY' ? 'var(--accent)' : r.verdict === 'HOLD' ? 'var(--gold)' : 'var(--muted)';
          const flagColor = flagColors[r.flag] || 'var(--muted)';
          return `
            <div class="holding-card" style="cursor:pointer;" onclick="switchTab('analyze');setTimeout(()=>{document.getElementById('ticker-input').value='${r.ticker}';runAnalysis();},100);">
              <div style="min-width:70px;">
                <div style="font-family:'DM Mono',monospace;font-size:0.78rem;color:var(--accent);letter-spacing:0.1em;font-weight:500;">${r.ticker}</div>
                <div style="font-family:'DM Mono',monospace;font-size:0.6rem;color:${flagColor};margin-top:4px;letter-spacing:0.06em;">${r.flag}</div>
              </div>
              <div style="flex:1;">
                <div style="font-size:0.92rem;color:var(--text);font-weight:500;margin-bottom:4px;">${r.name} <span style="font-size:0.72rem;color:var(--muted);font-weight:300;">· ${r.sector}</span></div>
                <div style="font-size:0.82rem;color:#8888aa;font-weight:300;line-height:1.5;">${r.why_it_fits}</div>
              </div>
              <div style="text-align:right;flex-shrink:0;min-width:90px;">
                <div style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--muted);margin-bottom:4px;">${r.key_metric}</div>
                <div style="font-family:'DM Mono',monospace;font-size:0.75rem;color:${verdictColor};letter-spacing:0.08em;margin-bottom:4px;">${r.verdict}</div>
                <div style="font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:${r.conviction>=7?'var(--accent)':r.conviction>=5?'var(--gold)':'var(--danger)'};">${r.conviction}<span style="font-size:0.8rem;color:var(--muted)">/10</span></div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
      <div style="margin-top:20px;font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);text-align:center;">
        Click any result to run a full analysis. Not financial advice.
      </div>
    `;

    document.getElementById('discover-results').style.display = 'block';
    document.getElementById('discover-results').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  let holdingCount = 1;
  function addHolding() {
    const container = document.getElementById('portfolio-holdings');
    const idx = holdingCount++;
    const row = document.createElement('div');
    row.className = 'portfolio-row';
    row.id = 'holding-'+idx;
    row.innerHTML = `
      <div class="search-wrapper" style="flex:1;">
        <div class="ticker-label">Ticker</div>
        <div class="search-container">
          <input type="text" class="holding-ticker" placeholder="e.g. MSFT" maxlength="10" autocomplete="off" style="width:100%;background:transparent;border:none;outline:none;padding:14px 16px;font-family:'DM Mono',monospace;font-size:1rem;color:var(--text);text-transform:uppercase;letter-spacing:0.08em;" />
        </div>
      </div>
      <div class="search-wrapper" style="width:140px;">
        <div class="ticker-label">Shares</div>
        <input type="number" class="holding-shares" placeholder="0" min="0" style="flex:1;width:80px;background:transparent;border:none;outline:none;padding:14px 12px;font-family:'DM Mono',monospace;font-size:1rem;color:var(--text);" />
      </div>
      <button onclick="removeHolding(${idx})" class="remove-btn">✕</button>
    `;
    container.appendChild(row);
  }

  function removeHolding(idx) {
    const row = document.getElementById('holding-'+idx);
    if (row) row.remove();
  }

  // ── PORTFOLIO ANALYSIS ──
  async function runPortfolioAnalysis() {
    const rows = document.querySelectorAll('.portfolio-row');
    const holdings = [];
    rows.forEach(row => {
      const ticker = row.querySelector('.holding-ticker').value.trim().toUpperCase();
      const shares = parseFloat(row.querySelector('.holding-shares').value) || 0;
      if (ticker) holdings.push({ ticker, shares });
    });

    const errEl = document.getElementById('portfolio-error');
    if (holdings.length < 2) {
      errEl.textContent = 'Please enter at least 2 stocks to analyze a portfolio.';
      errEl.style.display = 'block';
      return;
    }
    errEl.style.display = 'none';

    document.getElementById('portfolio-results').style.display = 'none';
    document.getElementById('portfolio-loading').style.display = 'block';

    try {
      document.getElementById('portfolio-loading-step').textContent = `Fetching data for ${holdings.length} holdings...`;
      const stockDataArr = await Promise.all(holdings.map(h => fetchStockData(h.ticker).catch(() => null)));

      document.getElementById('portfolio-loading-step').textContent = 'Running AI portfolio analysis...';
      const validHoldings = holdings.map((h, i) => ({ ...h, data: stockDataArr[i] })).filter(h => h.data);

      const portfolioAnalysis = await generatePortfolioAnalysis(validHoldings);

      document.getElementById('portfolio-loading').style.display = 'none';
      renderPortfolioResults(validHoldings, portfolioAnalysis);

    } catch(err) {
      document.getElementById('portfolio-loading').style.display = 'none';
      errEl.textContent = err.message || 'Something went wrong. Please try again.';
      errEl.style.display = 'block';
    }
  }

  async function generatePortfolioAnalysis(holdings) {
    const holdingSummaries = holdings.map(h => {
      const d = h.data;
      return `${h.ticker} (${d.name}): ${h.shares} shares @ $${d.currentPrice?.toFixed(2)} = $${(h.shares * d.currentPrice).toFixed(0)} | Sector: ${d.sector} | P/E: ${d.peRatio?.toFixed(1)||'N/A'} | Beta: ${d.beta?.toFixed(2)||'N/A'} | Rev Growth: ${d.revenueGrowth?(d.revenueGrowth*100).toFixed(1)+'%':'N/A'} | Margin: ${d.profitMargins?(d.profitMargins*100).toFixed(1)+'%':'N/A'}`;
    }).join('\n');

    const totalValue = holdings.reduce((sum, h) => sum + (h.shares * (h.data.currentPrice||0)), 0);

    const prompt = `You are a senior portfolio manager. Analyze this investment portfolio and return ONLY valid JSON with no markdown.

PORTFOLIO (Total Value: $${totalValue.toFixed(0)}):
${holdingSummaries}

Return this exact JSON structure:
{
  "portfolio_score": <integer 1-10>,
  "portfolio_grade": <"A" | "B" | "C" | "D">,
  "overall_verdict": <one sentence overall assessment>,
  "diversification_score": <1-10>,
  "risk_level": <"LOW" | "MODERATE" | "HIGH" | "VERY HIGH">,
  "summary": <2-3 sentence professional portfolio summary>,
  "sector_concentration": <one sentence on sector exposure and concentration risk>,
  "macro_exposure": <one sentence on how this portfolio is positioned relative to current macro environment>,
  "holdings_analysis": [
    {
      "ticker": <ticker>,
      "role": <"Core Hold" | "Strong Performer" | "Weak Link" | "Trim Candidate" | "Watch Closely">,
      "weight_pct": <percentage of portfolio this holding represents>,
      "score": <1-10>,
      "one_line": <one sentence assessment of this specific holding in the context of the portfolio>
    }
  ],
  "weak_links": [<ticker of weakest holding>, <ticker of second weakest if applicable>],
  "next_moves": [
    {"action": <"BUY" | "SELL" | "TRIM" | "HOLD" | "ADD">, "ticker": <ticker or "NEW POSITION">, "reason": <one sentence specific actionable rationale>},
    {"action": <...>, "ticker": <...>, "reason": <...>},
    {"action": <...>, "ticker": <...>, "reason": <...>}
  ],
  "plain_english": <2 sentence plain English summary of what this portfolio is and whether it is well constructed>
}`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1500,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) throw new Error('AI analysis failed.');
    const result = await response.json();
    const text = result.content[0].text.replace(/```json|```/g, '').trim();
    return JSON.parse(text);
  }

  function renderPortfolioResults(holdings, ai) {
    const totalValue = holdings.reduce((sum, h) => sum + (h.shares * (h.data.currentPrice||0)), 0);
    const content = document.getElementById('portfolio-content');

    const gradeClass = ai.portfolio_score >= 7 ? '' : ai.portfolio_score >= 5 ? 'medium' : 'low';
    const riskColor = ai.risk_level === 'LOW' ? 'var(--accent)' : ai.risk_level === 'MODERATE' ? 'var(--gold)' : 'var(--danger)';

    content.innerHTML = `
      <!-- Score block -->
      <div class="portfolio-score-block">
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:8px;">Portfolio Score</div>
          <div class="portfolio-grade ${gradeClass}">${ai.portfolio_score}<span style="font-size:2rem;color:var(--muted)">/10</span></div>
          <div style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--muted);margin-top:6px;letter-spacing:0.1em;">${ai.portfolio_grade} · ${ai.overall_verdict}</div>
        </div>
        <div style="flex:1;min-width:200px;">
          <div style="font-size:0.92rem;color:#b8b8cc;line-height:1.75;font-weight:300;">${ai.summary}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:16px;flex-shrink:0;">
          <div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:4px;">Total Value</div>
            <div style="font-family:'DM Mono',monospace;font-size:1.4rem;font-weight:500;color:var(--text);">$${formatLargeNumber(totalValue)}</div>
          </div>
          <div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:4px;">Risk Level</div>
            <div style="font-family:'DM Mono',monospace;font-size:1rem;font-weight:500;color:${riskColor};">${ai.risk_level}</div>
          </div>
          <div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:4px;">Diversification</div>
            <div style="font-family:'DM Mono',monospace;font-size:1rem;font-weight:500;color:var(--text);">${ai.diversification_score}/10</div>
          </div>
        </div>
      </div>

      <!-- Two col: macro + plain english -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
        <div class="analysis-card" style="opacity:1;animation:none;">
          <div class="card-label teal">Macro Positioning</div>
          <div class="card-content">${ai.macro_exposure}</div>
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);letter-spacing:0.12em;text-transform:uppercase;margin-bottom:6px;">Sector Concentration</div>
            <div class="card-content">${ai.sector_concentration}</div>
          </div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--accent);border-radius:4px;padding:28px;">
          <div class="card-label">Plain English</div>
          <div class="pe-quote" style="margin-top:0;">${ai.plain_english}</div>
        </div>
      </div>

      <!-- Next moves -->
      <div class="analysis-card" style="opacity:1;animation:none;margin-bottom:24px;">
        <div class="card-label gold">AI Recommended Next Moves</div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          ${ai.next_moves.map(m => {
            const actionColor = m.action==='BUY'||m.action==='ADD' ? 'var(--accent)' : m.action==='SELL'||m.action==='TRIM' ? 'var(--danger)' : 'var(--gold)';
            return `
            <div style="display:flex;align-items:flex-start;gap:16px;padding:14px;background:var(--surface2);border-radius:4px;">
              <div style="font-family:'DM Mono',monospace;font-size:0.72rem;font-weight:500;color:${actionColor};letter-spacing:0.1em;min-width:48px;padding-top:1px;">${m.action}</div>
              <div>
                <div style="font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--text);margin-bottom:4px;">${m.ticker}</div>
                <div style="font-size:0.85rem;color:#8888aa;font-weight:300;line-height:1.6;">${m.reason}</div>
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>

      <!-- Holdings breakdown -->
      <div class="card-label" style="margin-bottom:16px;">Holdings Breakdown</div>
      ${holdings.map(h => {
        const ha = ai.holdings_analysis.find(x => x.ticker === h.ticker) || {};
        const isWeak = ai.weak_links.includes(h.ticker);
        const val = h.shares * (h.data.currentPrice||0);
        const roleColor = ha.role==='Strong Performer' ? 'var(--accent)' : ha.role==='Weak Link'||ha.role==='Trim Candidate' ? 'var(--danger)' : 'var(--gold)';
        return `
        <div class="holding-card ${isWeak?'weak':ha.score>=7?'strong':''}">
          <div style="min-width:60px;">
            <div style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--accent);letter-spacing:0.1em;">${h.ticker}</div>
            <div style="font-size:0.78rem;color:var(--muted);margin-top:2px;">${h.shares} shares</div>
          </div>
          <div style="flex:1;">
            <div style="font-size:0.9rem;color:var(--text);font-weight:500;margin-bottom:4px;">${h.data.name}</div>
            <div style="font-size:0.8rem;color:#8888aa;font-weight:300;">${ha.one_line||''}</div>
          </div>
          <div style="text-align:right;flex-shrink:0;">
            <div style="font-family:'DM Mono',monospace;font-size:1rem;color:var(--text);">$${formatLargeNumber(val)}</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);margin-top:2px;">${ha.weight_pct||''}%</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.65rem;color:${roleColor};margin-top:4px;letter-spacing:0.08em;">${ha.role||''}</div>
          </div>
          <div style="font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;color:${(ha.score||5)>=7?'var(--accent)':(ha.score||5)>=5?'var(--gold)':'var(--danger)'};min-width:48px;text-align:right;">
            ${ha.score||'?'}<span style="font-size:0.9rem;color:var(--muted)">/10</span>
          </div>
        </div>`;
      }).join('')}
    `;

    document.getElementById('portfolio-results').style.display = 'block';
    document.getElementById('portfolio-results').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }


  // ── TICKER AUTOCOMPLETE DATABASE ──
  const TICKERS = [
    {t:'AAPL',n:'Apple Inc.',s:'Technology'},{t:'MSFT',n:'Microsoft Corp.',s:'Technology'},
    {t:'GOOGL',n:'Alphabet Inc.',s:'Technology'},{t:'GOOG',n:'Alphabet Inc. (C)',s:'Technology'},
    {t:'AMZN',n:'Amazon.com Inc.',s:'Consumer Cyclical'},{t:'NVDA',n:'NVIDIA Corp.',s:'Technology'},
    {t:'META',n:'Meta Platforms Inc.',s:'Technology'},{t:'TSLA',n:'Tesla Inc.',s:'Consumer Cyclical'},
    {t:'BRK.B',n:'Berkshire Hathaway B',s:'Financials'},{t:'LLY',n:'Eli Lilly & Co.',s:'Healthcare'},
    {t:'V',n:'Visa Inc.',s:'Financials'},{t:'JPM',n:'JPMorgan Chase & Co.',s:'Financials'},
    {t:'UNH',n:'UnitedHealth Group',s:'Healthcare'},{t:'XOM',n:'Exxon Mobil Corp.',s:'Energy'},
    {t:'MA',n:'Mastercard Inc.',s:'Financials'},{t:'JNJ',n:'Johnson & Johnson',s:'Healthcare'},
    {t:'PG',n:'Procter & Gamble Co.',s:'Consumer Staples'},{t:'HD',n:'Home Depot Inc.',s:'Consumer Cyclical'},
    {t:'AVGO',n:'Broadcom Inc.',s:'Technology'},{t:'MRK',n:'Merck & Co.',s:'Healthcare'},
    {t:'CVX',n:'Chevron Corp.',s:'Energy'},{t:'ABBV',n:'AbbVie Inc.',s:'Healthcare'},
    {t:'COST',n:'Costco Wholesale',s:'Consumer Staples'},{t:'AMD',n:'Advanced Micro Devices',s:'Technology'},
    {t:'NFLX',n:'Netflix Inc.',s:'Communication'},{t:'DIS',n:'Walt Disney Co.',s:'Communication'},
    {t:'ADBE',n:'Adobe Inc.',s:'Technology'},{t:'CRM',n:'Salesforce Inc.',s:'Technology'},
    {t:'ORCL',n:'Oracle Corp.',s:'Technology'},{t:'INTC',n:'Intel Corp.',s:'Technology'},
    {t:'QCOM',n:'Qualcomm Inc.',s:'Technology'},{t:'IBM',n:'IBM Corp.',s:'Technology'},
    {t:'GS',n:'Goldman Sachs Group',s:'Financials'},{t:'BAC',n:'Bank of America Corp.',s:'Financials'},
    {t:'WMT',n:'Walmart Inc.',s:'Consumer Staples'},{t:'KO',n:'Coca-Cola Co.',s:'Consumer Staples'},
    {t:'PEP',n:'PepsiCo Inc.',s:'Consumer Staples'},{t:'MCD',n:'McDonald\'s Corp.',s:'Consumer Cyclical'},
    {t:'NKE',n:'Nike Inc.',s:'Consumer Cyclical'},{t:'SBUX',n:'Starbucks Corp.',s:'Consumer Cyclical'},
    {t:'BA',n:'Boeing Co.',s:'Industrials'},{t:'CAT',n:'Caterpillar Inc.',s:'Industrials'},
    {t:'GE',n:'GE Aerospace',s:'Industrials'},{t:'F',n:'Ford Motor Co.',s:'Consumer Cyclical'},
    {t:'GM',n:'General Motors Co.',s:'Consumer Cyclical'},{t:'UBER',n:'Uber Technologies',s:'Technology'},
    {t:'LYFT',n:'Lyft Inc.',s:'Technology'},{t:'SNAP',n:'Snap Inc.',s:'Communication'},
    {t:'TWTR',n:'Twitter/X Corp.',s:'Communication'},{t:'PYPL',n:'PayPal Holdings',s:'Financials'},
    {t:'SQ',n:'Block Inc.',s:'Financials'},{t:'COIN',n:'Coinbase Global',s:'Financials'},
    {t:'PLTR',n:'Palantir Technologies',s:'Technology'},{t:'SNOW',n:'Snowflake Inc.',s:'Technology'},
    {t:'ABNB',n:'Airbnb Inc.',s:'Consumer Cyclical'},{t:'BKNG',n:'Booking Holdings',s:'Consumer Cyclical'},
    {t:'SPOT',n:'Spotify Technology',s:'Communication'},{t:'SHOP',n:'Shopify Inc.',s:'Technology'},
    {t:'ZM',n:'Zoom Video Comm.',s:'Technology'},{t:'DOCU',n:'DocuSign Inc.',s:'Technology'},
    {t:'NET',n:'Cloudflare Inc.',s:'Technology'},{t:'DDOG',n:'Datadog Inc.',s:'Technology'},
    {t:'CRWD',n:'CrowdStrike Holdings',s:'Technology'},{t:'S',n:'SentinelOne Inc.',s:'Technology'},
    {t:'TSM',n:'Taiwan Semiconductor',s:'Technology'},{t:'ASML',n:'ASML Holding',s:'Technology'},
    {t:'ARM',n:'Arm Holdings',s:'Technology'},{t:'SMCI',n:'Super Micro Computer',s:'Technology'},
    {t:'WFC',n:'Wells Fargo & Co.',s:'Financials'},{t:'MS',n:'Morgan Stanley',s:'Financials'},
    {t:'C',n:'Citigroup Inc.',s:'Financials'},{t:'AXP',n:'American Express Co.',s:'Financials'},
    {t:'PFE',n:'Pfizer Inc.',s:'Healthcare'},{t:'MRNA',n:'Moderna Inc.',s:'Healthcare'},
    {t:'BNTX',n:'BioNTech SE',s:'Healthcare'},{t:'AMGN',n:'Amgen Inc.',s:'Healthcare'},
    {t:'T',n:'AT&T Inc.',s:'Communication'},{t:'VZ',n:'Verizon Comm.',s:'Communication'},
    {t:'TMUS',n:'T-Mobile US Inc.',s:'Communication'},{t:'COP',n:'ConocoPhillips',s:'Energy'},
    {t:'SLB',n:'SLB (Schlumberger)',s:'Energy'},{t:'NEE',n:'NextEra Energy',s:'Utilities'},
    {t:'AMT',n:'American Tower Corp.',s:'Real Estate'},{t:'SPG',n:'Simon Property Group',s:'Real Estate'},
  ];

  function getAutocompleteSuggestions(query) {
    if (!query || query.length < 1) return [];
    const q = query.toUpperCase();
    return TICKERS.filter(item =>
      item.t.startsWith(q) ||
      item.n.toUpperCase().includes(q)
    ).slice(0, 7);
  }

  let activeIndex = -1;

  function setupAutocomplete() {
    const input = document.getElementById('ticker-input');
    const dropdown = document.getElementById('autocomplete-dropdown');
    if (!input || !dropdown) return;

    input.addEventListener('input', function() {
      const val = this.value.trim();
      const suggestions = getAutocompleteSuggestions(val);
      activeIndex = -1;

      if (!suggestions.length || !val) {
        dropdown.style.display = 'none';
        return;
      }

      dropdown.innerHTML = suggestions.map((s) => `
        <div class="autocomplete-item" data-ticker="${s.t}" onmousedown="selectTicker('${s.t}')">
          <span class="autocomplete-ticker">${s.t}</span>
          <span class="autocomplete-name">${s.n}</span>
          <span class="autocomplete-sector">${s.s}</span>
        </div>
      `).join('');
      dropdown.style.display = 'block';
    });

    input.addEventListener('keydown', function(e) {
      const items = dropdown.querySelectorAll('.autocomplete-item');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = Math.min(activeIndex + 1, items.length - 1);
        items.forEach((el, i) => el.classList.toggle('active', i === activeIndex));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = Math.max(activeIndex - 1, -1);
        items.forEach((el, i) => el.classList.toggle('active', i === activeIndex));
      } else if (e.key === 'Enter') {
        if (activeIndex >= 0 && items[activeIndex]) {
          e.preventDefault();
          selectTicker(items[activeIndex].dataset.ticker);
        } else {
          dropdown.style.display = 'none';
          runAnalysis();
        }
      } else if (e.key === 'Escape') {
        dropdown.style.display = 'none';
      }
    });

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-wrapper')) {
        dropdown.style.display = 'none';
      }
    });
  }

  function selectTicker(ticker) {
    document.getElementById('ticker-input').value = ticker;
    document.getElementById('autocomplete-dropdown').style.display = 'none';
    runAnalysis();
  }

  function exportPDF() {
    const pdfBlock = document.getElementById('pdf-report');
    if (!pdfBlock) {
      alert('Please run an analysis first before exporting.');
      return;
    }
    pdfBlock.style.cssText = 'display:block;position:fixed;top:0;left:0;width:100%;background:white;z-index:99999;overflow:auto;';
    document.body.style.overflow = 'hidden';
    setTimeout(() => {
      window.print();
      setTimeout(() => {
        pdfBlock.style.cssText = 'display:none;position:absolute;top:-99999px;left:0;width:0;height:0;overflow:hidden;';
        document.body.style.overflow = '';
      }, 500);
    }, 200);
  }

  // Show setup screen if no key saved
  window.addEventListener('DOMContentLoaded', () => {
    if (!ANTHROPIC_API_KEY) {
      document.getElementById('api-setup').style.display = 'flex';
    }
    setupAutocomplete();
    renderWatchlist();
  });

  function saveApiKey() {
    const key = document.getElementById('api-key-input').value.trim();
    const errEl = document.getElementById('api-error');
    if (!key || key.length < 20) {
      errEl.textContent = 'Please paste your full API key.';
      errEl.style.display = 'block';
      return;
    }
    errEl.style.display = 'none';
    ANTHROPIC_API_KEY = key;
    localStorage.setItem('clarity_api_key', key);
    document.getElementById('api-setup').style.display = 'none';
  }

  function quickPick(ticker) {
    document.getElementById('ticker-input').value = ticker;
    runAnalysis();
  }

  function setLoadingStep(text) {
    document.getElementById('loading-step').textContent = text;
  }

  async function runAnalysis() {
    const ticker = document.getElementById('ticker-input').value.trim().toUpperCase();
    if (!ticker) return;

    const errEl = document.getElementById('error-msg');
    errEl.style.display = 'none';
    document.getElementById('results').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    document.getElementById('analyze-btn').disabled = true;

    try {
      setLoadingStep('Running AI analysis...');
      const { stockData, analysis } = await fetchAndAnalyze(ticker);
      setLoadingStep('Building your report...');
      renderResults(ticker, stockData, analysis);

    } catch (err) {
      document.getElementById('loading').style.display = 'none';
      errEl.textContent = err.message || 'Something went wrong. Please try again.';
      errEl.style.display = 'block';
    } finally {
      document.getElementById('analyze-btn').disabled = false;
    }
  }

  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  async function fetchStockData(ticker) {
    const prompt = `For the stock ticker "${ticker}", return ONLY this JSON with no markdown:
{
  "valid": true,
  "name": "Full Company Name",
  "sector": "Sector",
  "industry": "Industry",
  "currentPrice": 150.00,
  "change1d": 0.012,
  "marketCap": 2400000000000,
  "peRatio": 28.5,
  "forwardPE": 24.0,
  "beta": 1.2,
  "fiftyTwoWeekHigh": 200.00,
  "fiftyTwoWeekLow": 130.00,
  "revenueGrowth": 0.08,
  "profitMargins": 0.25,
  "returnOnEquity": 0.45,
  "debtToEquity": 150.0,
  "freeCashflow": 90000000000,
  "targetMeanPrice": 210.00
}
If the ticker is invalid, set valid to false.`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 600,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) throw new Error('Could not fetch data for ' + ticker);
    const result = await response.json();
    const text = result.content[0].text.replace(/```json|```/g, '').trim();
    const data = JSON.parse(text);
    if (!data.valid) throw new Error('Ticker not found: ' + ticker);
    return data;
  }

  async function fetchAndAnalyze(ticker) {
    const prompt = `You are both a financial data API and a senior equity research analyst at a top-tier hedge fund. For the stock ticker "${ticker}", return financial data AND a full institutional-grade research report.

If the ticker is invalid or unknown, set stockData.valid to false.

Return ONLY this exact JSON, no markdown, no explanation:
{
  "stockData": {
    "valid": true,
    "name": "Full Company Name",
    "sector": "Sector",
    "industry": "Industry",
    "description": "2 sentence company description",
    "currentPrice": 150.00,
    "change1d": 0.012,
    "marketCap": 2400000000000,
    "peRatio": 28.5,
    "forwardPE": 24.0,
    "pbRatio": 8.2,
    "psRatio": 6.5,
    "beta": 1.2,
    "fiftyTwoWeekHigh": 200.00,
    "fiftyTwoWeekLow": 130.00,
    "revenueGrowth": 0.08,
    "earningsGrowth": 0.12,
    "profitMargins": 0.25,
    "returnOnEquity": 0.45,
    "debtToEquity": 150.0,
    "currentRatio": 1.2,
    "freeCashflow": 90000000000,
    "targetMeanPrice": 210.00,
    "recommendationKey": "buy"
  },
  "analysis": {
    "conviction_model": {
      "valuation_score": 7,
      "quality_score": 8,
      "growth_score": 7,
      "risk_score": 6,
      "macro_score": 5,
      "conviction_score": 7,
      "verdict": "BUY",
      "valuation_note": "One sentence on valuation sub-score",
      "quality_note": "One sentence on quality sub-score",
      "growth_note": "One sentence on growth sub-score",
      "risk_note": "One sentence on risk sub-score",
      "macro_note": "One sentence on macro sub-score"
    },
    "dcf": {
      "revenue_growth_assumption": 0.12,
      "margin_assumption": 0.25,
      "discount_rate": 0.10,
      "terminal_multiple": 20,
      "base_case_price": 175.00,
      "bull_case_price": 220.00,
      "bear_case_price": 140.00,
      "upside_downside": 0.15,
      "dcf_note": "One sentence explaining the key assumption driving the valuation"
    },
    "sensitivity": {
      "scenarios": [
        {"assumption": "Revenue growth -2%", "price_impact": -18.00, "new_price": 157.00},
        {"assumption": "Margins compress 200bps", "price_impact": -12.00, "new_price": 163.00},
        {"assumption": "Discount rate +1%", "price_impact": -15.00, "new_price": 160.00},
        {"assumption": "Revenue growth +2%", "price_impact": 20.00, "new_price": 195.00},
        {"assumption": "Multiple expansion 2x", "price_impact": 22.00, "new_price": 197.00}
      ]
    },
    "analyst_summary": "2-3 sentence professional summary",
    "plain_english": "2-3 sentence plain English explanation for first-time investors",
    "reward_factors": [
      {"name": "Factor name", "score": 8, "detail": "One sentence explanation"},
      {"name": "Factor name", "score": 7, "detail": "One sentence explanation"},
      {"name": "Factor name", "score": 6, "detail": "One sentence explanation"}
    ],
    "risk_factors": [
      {"name": "Risk name", "score": 7, "detail": "One sentence explanation"},
      {"name": "Risk name", "score": 6, "detail": "One sentence explanation"},
      {"name": "Risk name", "score": 5, "detail": "One sentence explanation"}
    ],
    "valuation_take": "2 sentences on whether stock is cheap, fairly valued, or expensive",
    "macro_sensitivity": "1 sentence on how interest rates affect this stock",
    "what_could_go_wrong": "2 sentences on the biggest bear case, be specific",
    "what_drives_stock": "2 sentences on the 1-2 key metrics or catalysts that will drive this stock up or down over the next 12 months",
    "macro_context": {
      "rate_sensitivity": "HIGH",
      "rate_impact": "NEGATIVE",
      "rate_note": "Short note on rate sensitivity"
    }
  }
}`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2500,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error('API error: ' + (err.error?.message || 'Check your API key and try again.'));
    }

    const result = await response.json();
    const text = result.content[0].text.replace(/```json|```/g, '').trim();
    const parsed = JSON.parse(text);

    if (!parsed.stockData?.valid) throw new Error(`Ticker "${ticker}" not found. Please check and try again.`);
    return { stockData: parsed.stockData, analysis: parsed.analysis };
  }

  // ── TOOLTIP DEFINITIONS ──
  const TOOLTIPS = {
    'Price': {
      title: 'Current Price',
      body: 'The price of one share of this stock right now.',
      context: 'Compare this to the 52-week range to see if the stock is near its highs or lows.'
    },
    'Market Cap': {
      title: 'Market Capitalization',
      body: 'The total value of the company — share price × total shares. Think of it as what it would cost to buy the entire company.',
      context: 'Large cap (>$10B) = established. Mid cap ($2–10B) = growing. Small cap (<$2B) = higher risk/reward.'
    },
    'P/E Ratio': {
      title: 'Price-to-Earnings Ratio',
      body: 'How much investors pay for every $1 of profit. A P/E of 25x means you\'re paying $25 for $1 of earnings.',
      context: 'Lower P/E can mean cheaper. Higher P/E means investors expect strong future growth. Compare to industry peers.'
    },
    'Revenue Growth': {
      title: 'Revenue Growth (Year over Year)',
      body: 'How much the company\'s total sales grew compared to the same period last year.',
      context: 'Positive and accelerating is best. Slowing growth often signals market saturation.'
    },
    'Profit Margin': {
      title: 'Net Profit Margin',
      body: 'Out of every $1 in revenue, how many cents does the company keep as profit after all expenses.',
      context: 'Higher margins = more efficient business. Software companies often have 20–30%+. Grocery stores often <5%.'
    },
    'Beta': {
      title: 'Beta — Volatility vs. Market',
      body: 'Measures how much this stock moves compared to the overall market. Beta of 1.5 means 50% more volatile than the S&P 500.',
      context: 'Beta >1 = higher risk, higher potential reward. Beta <1 = more stable, lower potential swings. Negative beta = moves opposite to market.'
    },
    'Analyst Target': {
      title: 'Wall Street Analyst Price Target',
      body: 'The average price target set by professional analysts who cover this stock. Represents where they think the stock will be in 12 months.',
      context: 'If target > current price, analysts are bullish. Take with a grain of salt — analysts can be wrong and have conflicts of interest.'
    },
    '52W Range': {
      title: '52-Week Price Range',
      body: 'The lowest and highest price this stock has traded at over the past year.',
      context: 'Near the 52-week low could mean opportunity or trouble. Near the high could mean momentum or overvaluation.'
    },
    'Valuation': {
      title: 'Valuation Score (30% of conviction)',
      body: 'Measures whether the stock is cheap or expensive relative to its earnings, growth, and peers.',
      context: 'Based on P/E, forward P/E, Price/Sales, and Price/Book ratios compared to historical averages.'
    },
    'Quality': {
      title: 'Quality Score (25% of conviction)',
      body: 'Measures the strength of the business — profitability, balance sheet health, and competitive moat.',
      context: 'Based on profit margins, return on equity, debt levels, and free cash flow generation.'
    },
    'Growth': {
      title: 'Growth Score (20% of conviction)',
      body: 'Measures how fast the company is growing revenue and earnings, and whether that growth is accelerating.',
      context: 'Based on year-over-year revenue growth, earnings growth, and forward estimates.'
    },
    'Risk': {
      title: 'Risk Score (15% of conviction)',
      body: 'Measures how risky this investment is — including debt levels, volatility, and business concentration.',
      context: 'Higher risk score = more risk. Based on beta, debt/equity, business model risk, and competitive threats.'
    },
    'Macro': {
      title: 'Macro Score (10% of conviction)',
      body: 'Measures how favorable the current economic environment is for this stock — interest rates, inflation, sector tailwinds.',
      context: 'High-growth tech stocks suffer more when rates rise. Energy stocks benefit from commodity cycles.'
    },
    'DCF': {
      title: 'Discounted Cash Flow (DCF) Valuation',
      body: 'The gold standard valuation method used by professional investors. Projects future cash flows and discounts them back to today\'s value.',
      context: 'If DCF value > current price, the stock may be undervalued. If lower, it may be overvalued.'
    },
    'WACC': {
      title: 'Discount Rate (WACC)',
      body: 'Weighted Average Cost of Capital — the rate used to discount future cash flows back to today\'s dollars. Higher rates = lower valuations.',
      context: 'When interest rates rise, WACC rises too, which lowers DCF valuations. This is why rate hikes hurt growth stocks.'
    },
    'Terminal Multiple': {
      title: 'Terminal Multiple',
      body: 'The earnings multiple used to estimate the company\'s value at the end of the projection period — essentially what someone would pay for it then.',
      context: 'Higher quality businesses with strong moats deserve higher terminal multiples.'
    },
    'Sensitivity': {
      title: 'Sensitivity Analysis',
      body: 'Shows how the price target changes if our key assumptions turn out to be wrong. Elite analysts always stress-test their models.',
      context: 'If the stock holds value even in bad scenarios, that\'s a margin of safety. If small changes destroy value, the thesis is fragile.'
    },
    'Conviction': {
      title: 'AI Conviction Score',
      body: 'A weighted score from 1–10 combining valuation, quality, growth, risk, and macro factors. Built on the same framework used by institutional investors.',
      context: '8–10 = Strong opportunity. 6–7 = Solid but not exceptional. 4–5 = Neutral. Below 4 = Significant concerns.'
    },
  };

  function makeTooltip(key) {
    const t = TOOLTIPS[key];
    if (!t) return '';
    return `<div class="tooltip-box">
      <div class="tooltip-title">${t.title}</div>
      <div class="tooltip-body">${t.body}</div>
      ${t.context ? `<div class="tooltip-context">💡 ${t.context}</div>` : ''}
    </div>`;
  }

  function formatLargeNumber(n) {
    if (!n) return 'N/A';
    if (n >= 1e12) return (n / 1e12).toFixed(2) + 'T';
    if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
    return n.toFixed(0);
  }

  function pct(val) {
    if (val == null) return 'N/A';
    return (val * 100).toFixed(1) + '%';
  }

  function renderResults(ticker, data, ai) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('compare-results').style.display = 'none';
    const results = document.getElementById('results');
    results.style.display = 'block';

    // Track current ticker for watchlist
    currentTicker = ticker;
    updateWatchlistBtn(ticker);

    // Report timestamp
    const now = new Date();
    const stamp = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) +
      ' · ' + now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    document.getElementById('report-timestamp').textContent = `Report generated: ${stamp}`;

    const cm = ai.conviction_model;
    const dcf = ai.dcf;
    const sens = ai.sensitivity;

    // Header
    document.getElementById('res-ticker').textContent = ticker;
    document.getElementById('res-name').textContent = data.name;
    document.getElementById('res-sector').textContent = `${data.sector} · ${data.industry}`;

    // Conviction
    const convEl = document.getElementById('res-conviction');
    convEl.textContent = cm.conviction_score + '/10';
    convEl.className = 'conviction-score tooltip-wrap';
    convEl.innerHTML = cm.conviction_score + '/10' + makeTooltip('Conviction');
    if (cm.conviction_score < 5) convEl.classList.add('low');
    else if (cm.conviction_score < 7) convEl.classList.add('medium');
    document.getElementById('res-verdict').textContent = cm.verdict;

    // Metrics bar
    const metrics = [
      { name: 'Price', value: data.currentPrice ? `$${data.currentPrice.toFixed(2)}` : 'N/A', delta: data.change1d ? `${(data.change1d*100).toFixed(2)}% today` : '', cls: data.change1d >= 0 ? 'positive' : 'negative' },
      { name: 'Market Cap', value: formatLargeNumber(data.marketCap), delta: data.sector || '' },
      { name: 'P/E Ratio', value: data.peRatio ? data.peRatio.toFixed(1) + 'x' : 'N/A', delta: `Fwd: ${data.forwardPE ? data.forwardPE.toFixed(1) + 'x' : 'N/A'}` },
      { name: 'Revenue Growth', value: data.revenueGrowth ? pct(data.revenueGrowth) : 'N/A', cls: data.revenueGrowth > 0 ? 'positive' : 'negative' },
      { name: 'Profit Margin', value: data.profitMargins ? pct(data.profitMargins) : 'N/A', cls: data.profitMargins > 0.15 ? 'positive' : '' },
      { name: 'Beta', value: data.beta ? data.beta.toFixed(2) : 'N/A', delta: 'vs market' },
      { name: 'Analyst Target', value: data.targetMeanPrice ? `$${data.targetMeanPrice.toFixed(2)}` : 'N/A', cls: data.targetMeanPrice > data.currentPrice ? 'positive' : 'negative' },
      { name: '52W Range', value: `$${data.fiftyTwoWeekLow?.toFixed(0)}–$${data.fiftyTwoWeekHigh?.toFixed(0)}`, delta: '' },
    ];

    document.getElementById('metrics-bar').innerHTML = metrics.map(m => `
      <div class="metric-cell tooltip-wrap">
        <div class="metric-name">${m.name}</div>
        <div class="metric-value ${m.cls || ''}">${m.value}</div>
        ${m.delta ? `<div class="metric-delta">${m.delta}</div>` : ''}
        ${makeTooltip(m.name)}
      </div>
    `).join('');

    // Macro bar
    const mc = ai.macro_context;
    const rateColor = mc.rate_impact === 'POSITIVE' ? '#c8f04a' : mc.rate_impact === 'NEGATIVE' ? '#f04a6e' : '#f0c84a';
    document.getElementById('macro-bar').innerHTML = `
      <div class="macro-item">
        <div class="macro-dot" style="background:#6b6b8a"></div>
        <div class="macro-text"><strong>Macro Overlay</strong></div>
      </div>
      <div class="macro-item">
        <div class="macro-dot" style="background:${rateColor}"></div>
        <div class="macro-text">Rate Sensitivity: <strong>${mc.rate_sensitivity}</strong></div>
      </div>
      <div class="macro-item">
        <div class="macro-dot" style="background:${rateColor}"></div>
        <div class="macro-text">Rate Impact: <strong>${mc.rate_impact}</strong></div>
      </div>
      <div class="macro-item" style="flex:1">
        <div class="macro-text" style="color:#8888aa">${mc.rate_note}</div>
      </div>
    `;

    // Analysis grid
    const grid = document.getElementById('analysis-grid');
    grid.innerHTML = '';

    // ── CONVICTION MODEL BREAKDOWN (full width) ──
    const convWeights = [
      { label: 'Valuation', weight: '30%', score: cm.valuation_score, note: cm.valuation_note, color: '#c8f04a' },
      { label: 'Quality', weight: '25%', score: cm.quality_score, note: cm.quality_note, color: '#4af0c8' },
      { label: 'Growth', weight: '20%', score: cm.growth_score, note: cm.growth_note, color: '#f0c84a' },
      { label: 'Risk', weight: '15%', score: cm.risk_score, note: cm.risk_note, color: '#f04a6e' },
      { label: 'Macro', weight: '10%', score: cm.macro_score, note: cm.macro_note, color: '#a04af0' },
    ];
    const convCard = document.createElement('div');
    convCard.className = 'analysis-card';
    convCard.style.gridColumn = '1 / -1';
    convCard.innerHTML = `
      <div class="card-label">Conviction Model Breakdown</div>
      <div style="font-size:0.78rem;color:var(--muted);margin-bottom:20px;font-weight:300">
        Score = (Valuation × 30%) + (Quality × 25%) + (Growth × 20%) + (Risk × 15%) + (Macro × 10%)
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;">
        ${convWeights.map(w => `
          <div class="tooltip-wrap" style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <span style="font-family:'DM Mono',monospace;font-size:0.68rem;color:${w.color};letter-spacing:0.1em;text-transform:uppercase">${w.label}</span>
              <span style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted)">${w.weight}</span>
            </div>
            <div style="font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;color:${w.color};line-height:1">${w.score}<span style="font-size:1rem;color:var(--muted)">/10</span></div>
            <div style="font-size:0.75rem;color:var(--muted);margin-top:8px;line-height:1.5;font-weight:300">${w.note}</div>
            ${makeTooltip(w.label)}
          </div>
        `).join('')}
      </div>
    `;
    grid.appendChild(convCard);

    // ── REWARD / RISK cards ──
    const rewardCard = document.createElement('div');
    rewardCard.className = 'analysis-card';
    rewardCard.innerHTML = `
      <div class="card-label">Reward Factors</div>
      ${ai.reward_factors.map(f => `
        <div class="rr-item">
          <div class="rr-header"><span class="rr-name">${f.name}</span><span class="rr-score">${f.score}/10</span></div>
          <div class="rr-bar-bg"><div class="rr-bar-fill fill-reward" style="width:0%" data-width="${f.score * 10}%"></div></div>
          <div style="font-size:0.78rem;color:var(--muted);margin-top:6px;font-weight:300">${f.detail}</div>
        </div>
      `).join('')}
    `;
    grid.appendChild(rewardCard);

    const riskCard = document.createElement('div');
    riskCard.className = 'analysis-card';
    riskCard.innerHTML = `
      <div class="card-label danger">Risk Factors</div>
      ${ai.risk_factors.map(f => `
        <div class="rr-item">
          <div class="rr-header"><span class="rr-name">${f.name}</span><span class="rr-score">${f.score}/10</span></div>
          <div class="rr-bar-bg"><div class="rr-bar-fill fill-risk" style="width:0%" data-width="${f.score * 10}%"></div></div>
          <div style="font-size:0.78rem;color:var(--muted);margin-top:6px;font-weight:300">${f.detail}</div>
        </div>
      `).join('')}
    `;
    grid.appendChild(riskCard);

    // ── DCF VALUATION MODEL ──
    const upside = dcf.upside_downside;
    const upsideColor = upside >= 0 ? '#c8f04a' : '#f04a6e';
    const dcfCard = document.createElement('div');
    dcfCard.className = 'analysis-card';
    dcfCard.style.gridColumn = '1 / -1';
    dcfCard.innerHTML = `
      <div class="card-label gold">DCF Valuation Model</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:start">
        <div>
          <div style="font-size:0.78rem;color:var(--muted);margin-bottom:16px;font-weight:300">${dcf.dcf_note}</div>
          <div style="display:grid;gap:8px;">
            ${[
              ['Revenue Growth Assumption', pct(dcf.revenue_growth_assumption), 'Revenue Growth'],
              ['Margin Assumption', pct(dcf.margin_assumption), 'Profit Margin'],
              ['Discount Rate (WACC)', pct(dcf.discount_rate), 'WACC'],
              ['Terminal Multiple', dcf.terminal_multiple + 'x', 'Terminal Multiple'],
            ].map(([k,v,tip]) => `
              <div class="tooltip-wrap" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
                <span style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted)">${k}</span>
                <span style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--text)">${v}</span>
                ${makeTooltip(tip)}
              </div>
            `).join('')}
          </div>
        </div>
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:16px;">Price Targets</div>
          <div style="display:grid;gap:10px;">
            <div style="background:rgba(200,240,74,0.08);border:1px solid rgba(200,240,74,0.3);border-radius:4px;padding:14px;display:flex;justify-content:space-between;align-items:center;">
              <span style="font-family:'DM Mono',monospace;font-size:0.72rem;color:#c8f04a">BULL CASE</span>
              <span style="font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:#c8f04a">$${dcf.bull_case_price.toFixed(0)}</span>
            </div>
            <div style="background:rgba(240,200,74,0.08);border:1px solid rgba(240,200,74,0.3);border-radius:4px;padding:14px;display:flex;justify-content:space-between;align-items:center;">
              <span style="font-family:'DM Mono',monospace;font-size:0.72rem;color:#f0c84a">BASE CASE</span>
              <span style="font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:#f0c84a">$${dcf.base_case_price.toFixed(0)}</span>
            </div>
            <div style="background:rgba(240,74,110,0.08);border:1px solid rgba(240,74,110,0.3);border-radius:4px;padding:14px;display:flex;justify-content:space-between;align-items:center;">
              <span style="font-family:'DM Mono',monospace;font-size:0.72rem;color:#f04a6e">BEAR CASE</span>
              <span style="font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:#f04a6e">$${dcf.bear_case_price.toFixed(0)}</span>
            </div>
            <div style="text-align:center;margin-top:4px;">
              <span style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted)">Base case implies </span>
              <span style="font-family:'DM Mono',monospace;font-size:0.7rem;color:${upsideColor};font-weight:500">${upside >= 0 ? '+' : ''}${(upside * 100).toFixed(1)}% ${upside >= 0 ? 'upside' : 'downside'}</span>
              <span style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted)"> from current price</span>
            </div>
          </div>
        </div>
      </div>
    `;
    grid.appendChild(dcfCard);

    // ── SENSITIVITY TABLE ──
    const sensCard = document.createElement('div');
    sensCard.className = 'analysis-card';
    sensCard.style.gridColumn = '1 / -1';
    sensCard.innerHTML = `
      <div class="card-label teal tooltip-wrap" style="display:inline-flex;align-items:center;gap:6px;">
        Sensitivity Analysis — Stress Testing Assumptions
        ${makeTooltip('Sensitivity')}
      </div>
      <div style="font-size:0.78rem;color:var(--muted);margin-bottom:16px;font-weight:300">How would different scenarios affect the base case price target of $${dcf.base_case_price.toFixed(0)}?</div>
      <div style="display:grid;gap:8px;">
        <div style="display:grid;grid-template-columns:1fr auto auto;gap:16px;padding:8px 0;border-bottom:1px solid var(--border);">
          <span style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase">Assumption Change</span>
          <span style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;text-align:right">Impact</span>
          <span style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;text-align:right">New Target</span>
        </div>
        ${sens.scenarios.map(s => {
          const pos = s.price_impact >= 0;
          const color = pos ? '#c8f04a' : '#f04a6e';
          return `
            <div style="display:grid;grid-template-columns:1fr auto auto;gap:16px;padding:10px 0;border-bottom:1px solid rgba(42,42,61,0.5);align-items:center;">
              <span style="font-size:0.85rem;color:var(--text)">${s.assumption}</span>
              <span style="font-family:'DM Mono',monospace;font-size:0.8rem;color:${color};text-align:right">${pos ? '+' : ''}$${s.price_impact.toFixed(0)}</span>
              <span style="font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--text);text-align:right">$${s.new_price.toFixed(0)}</span>
            </div>
          `;
        }).join('')}
      </div>
    `;
    grid.appendChild(sensCard);

    // ── WHAT DRIVES THE STOCK + ANALYST SUMMARY (full width) ──
    const summaryCard = document.createElement('div');
    summaryCard.className = 'analysis-card';
    summaryCard.style.gridColumn = '1 / -1';
    summaryCard.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:24px;">
        <div>
          <div class="card-label gold">What Drives This Stock?</div>
          <div class="card-content">${ai.what_drives_stock}</div>
        </div>
        <div>
          <div class="card-label teal">Analyst Summary</div>
          <div class="card-content">${ai.analyst_summary}</div>
        </div>
        <div>
          <div class="card-label danger">Bear Case — What Could Go Wrong</div>
          <div class="card-content" style="color:#cc9999">${ai.what_could_go_wrong}</div>
          <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
            <div class="card-label" style="font-size:0.6rem;color:var(--muted);margin-bottom:8px">MACRO SENSITIVITY</div>
            <div class="card-content">${ai.macro_sensitivity}</div>
          </div>
        </div>
      </div>
    `;
    grid.appendChild(summaryCard);

    // ── PLAIN ENGLISH (full width) ──
    const peCard = document.createElement('div');
    peCard.className = 'plain-english';
    peCard.innerHTML = `
      <div class="card-label">Plain English — For Every Investor</div>
      <div class="pe-quote">${ai.plain_english}</div>
    `;
    grid.appendChild(peCard);

    // ── PDF HIDDEN CONTENT (only shows when printing) ──
    const prevPdf = document.getElementById('pdf-report');
    if (prevPdf) prevPdf.remove();

    const verdictColor = cm.verdict.includes('BUY') ? '#1a6b1a' : cm.verdict === 'HOLD' ? '#8a6a00' : '#8a0000';
    const reportDate = new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});

    // Build all sections as real JS (no nested template literals)
    const metricsHtml = [
      ['Price', data.currentPrice ? '$'+data.currentPrice.toFixed(2) : 'N/A'],
      ['Mkt Cap', formatLargeNumber(data.marketCap)],
      ['P/E', data.peRatio ? data.peRatio.toFixed(1)+'x' : 'N/A'],
      ['Fwd P/E', data.forwardPE ? data.forwardPE.toFixed(1)+'x' : 'N/A'],
      ['Rev Growth', data.revenueGrowth ? pct(data.revenueGrowth) : 'N/A'],
      ['Margin', data.profitMargins ? pct(data.profitMargins) : 'N/A'],
      ['ROE', data.returnOnEquity ? pct(data.returnOnEquity) : 'N/A'],
      ['Beta', data.beta ? data.beta.toFixed(2) : 'N/A'],
    ].map(function(row) {
      return '<div style="background:white;padding:8px 10px;"><div style="font-size:8px;color:#888;text-transform:uppercase;letter-spacing:0.08em;font-family:monospace;margin-bottom:2px;">'+row[0]+'</div><div style="font-size:13px;font-weight:700;">'+row[1]+'</div></div>';
    }).join('');

    const convModelHtml = [
      ['Valuation','30%',cm.valuation_score,cm.valuation_note],
      ['Quality','25%',cm.quality_score,cm.quality_note],
      ['Growth','20%',cm.growth_score,cm.growth_note],
      ['Risk','15%',cm.risk_score,cm.risk_note],
      ['Macro','10%',cm.macro_score,cm.macro_note],
    ].map(function(row) {
      return '<div style="background:white;padding:8px 10px;"><div style="display:flex;justify-content:space-between;"><span style="font-size:8px;color:#555;text-transform:uppercase;font-family:monospace;">'+row[0]+'</span><span style="font-size:8px;color:#aaa;font-family:monospace;">'+row[1]+'</span></div><div style="font-size:16px;font-weight:700;margin:2px 0;">'+row[2]+'<span style="font-size:9px;color:#aaa;">/10</span></div><div style="font-size:8px;color:#666;line-height:1.3;">'+row[3]+'</div></div>';
    }).join('');

    const dcfRowsHtml = [
      ['Revenue Growth', pct(dcf.revenue_growth_assumption)],
      ['Margin Assumption', pct(dcf.margin_assumption)],
      ['Discount Rate (WACC)', pct(dcf.discount_rate)],
      ['Terminal Multiple', dcf.terminal_multiple+'x'],
    ].map(function(row) {
      return '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;font-size:10px;"><span style="color:#666;">'+row[0]+'</span><span style="font-weight:700;">'+row[1]+'</span></div>';
    }).join('');

    const sensHtml = sens.scenarios.map(function(s) {
      var col = s.price_impact >= 0 ? '#1a6b1a' : '#8a0000';
      var sign = s.price_impact >= 0 ? '+' : '';
      return '<div style="display:grid;grid-template-columns:1fr 48px 48px;gap:4px;padding:4px 0;border-bottom:1px solid #f0f0f0;font-size:10px;align-items:center;"><span style="color:#333;">'+s.assumption+'</span><span style="font-family:monospace;color:'+col+';text-align:right;">'+sign+'$'+s.price_impact.toFixed(0)+'</span><span style="font-family:monospace;font-weight:700;text-align:right;">$'+s.new_price.toFixed(0)+'</span></div>';
    }).join('');

    const rewardHtml = ai.reward_factors.map(function(f) {
      return '<div style="margin-bottom:8px;"><div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:2px;"><span style="font-weight:700;">'+f.name+'</span><span style="color:#1a6b1a;font-family:monospace;">'+f.score+'/10</span></div><div style="height:2px;background:#eee;border-radius:1px;margin-bottom:3px;"><div style="height:100%;width:'+f.score*10+'%;background:#2d7a2d;"></div></div><div style="font-size:9px;color:#666;">'+f.detail+'</div></div>';
    }).join('');

    const riskHtml = ai.risk_factors.map(function(f) {
      return '<div style="margin-bottom:8px;"><div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:2px;"><span style="font-weight:700;">'+f.name+'</span><span style="color:#8a0000;font-family:monospace;">'+f.score+'/10</span></div><div style="height:2px;background:#eee;border-radius:1px;margin-bottom:3px;"><div style="height:100%;width:'+f.score*10+'%;background:#a01a1a;"></div></div><div style="font-size:9px;color:#666;">'+f.detail+'</div></div>';
    }).join('');

    // Remove any old pdf block
    const existingPdf = document.getElementById('pdf-report');
    if (existingPdf) existingPdf.remove();

    const pdfBlock = document.createElement('div');
    pdfBlock.id = 'pdf-report';
    pdfBlock.style.cssText = 'display:none;position:absolute;top:-99999px;left:0;width:0;height:0;overflow:hidden;';

    pdfBlock.innerHTML = `
    <div style="width:816px;height:1056px;overflow:hidden;background:white;position:relative;">
    <div style="transform:scale(0.72);transform-origin:top left;width:1133px;font-family:'Times New Roman',Georgia,serif;color:#111;background:white;padding:36px 44px;font-size:10.5px;line-height:1.4;">

      <!-- HEADER BAR -->
      <div style="background:#0a1628;color:white;padding:14px 20px;margin:-40px -48px 28px -48px;display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-size:8px;letter-spacing:0.25em;text-transform:uppercase;color:#aabbdd;font-family:'Courier New',monospace;margin-bottom:2px;">Clarity Equity Research</div>
          <div style="font-size:14px;font-weight:700;letter-spacing:0.02em;color:white;">INITIATING COVERAGE</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:8px;color:#aabbdd;font-family:'Courier New',monospace;">${reportDate}</div>
          <div style="font-size:8px;color:#aabbdd;font-family:'Courier New',monospace;margin-top:2px;">NOT FINANCIAL ADVICE · EDUCATIONAL USE ONLY</div>
        </div>
      </div>

      <!-- COMPANY HEADER -->
      <div style="display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:16px;border-bottom:2px solid #0a1628;margin-bottom:20px;">
        <div>
          <div style="font-size:22px;font-weight:700;letter-spacing:-0.02em;color:#0a1628;line-height:1.1;">${data.name}</div>
          <div style="font-size:10px;color:#555;margin-top:5px;font-family:'Courier New',monospace;letter-spacing:0.05em;">${ticker} &nbsp;·&nbsp; ${data.sector} &nbsp;·&nbsp; ${data.industry}</div>
          <div style="margin-top:12px;font-size:10px;color:#333;max-width:480px;line-height:1.6;font-style:italic;">${ai.analyst_summary}</div>
        </div>
        <div style="text-align:center;background:#f8f8f8;border:1px solid #ddd;padding:16px 24px;min-width:120px;flex-shrink:0;margin-left:24px;">
          <div style="font-size:7.5px;letter-spacing:0.2em;text-transform:uppercase;color:#888;font-family:'Courier New',monospace;margin-bottom:6px;">Rating</div>
          <div style="font-size:20px;font-weight:700;color:${verdictColor};letter-spacing:0.02em;">${cm.verdict}</div>
          <div style="border-top:1px solid #ddd;margin:8px 0;"></div>
          <div style="font-size:7.5px;letter-spacing:0.15em;text-transform:uppercase;color:#888;font-family:'Courier New',monospace;margin-bottom:4px;">Conviction</div>
          <div style="font-size:20px;font-weight:700;color:#0a1628;">${cm.conviction_score}<span style="font-size:11px;color:#888;font-weight:400;">/10</span></div>
          <div style="border-top:1px solid #ddd;margin:8px 0;"></div>
          <div style="font-size:7.5px;color:#888;font-family:'Courier New',monospace;">Price Target</div>
          <div style="font-size:14px;font-weight:700;color:#0a1628;">${data.targetMeanPrice ? '$'+data.targetMeanPrice.toFixed(2) : 'N/A'}</div>
        </div>
      </div>

      <!-- SECTION: KEY METRICS -->
      <div style="margin-bottom:12px;">
        <div style="font-size:7.5px;letter-spacing:0.2em;text-transform:uppercase;color:#0a1628;font-family:'Courier New',monospace;border-bottom:1px solid #0a1628;padding-bottom:4px;margin-bottom:10px;font-weight:700;">KEY METRICS</div>
        <table style="width:100%;border-collapse:collapse;font-size:9.5px;">
          <tr style="background:#0a1628;color:white;">
            <th style="padding:5px 8px;text-align:left;font-family:'Courier New',monospace;font-weight:600;font-size:7.5px;letter-spacing:0.1em;">PRICE</th>
            <th style="padding:5px 8px;text-align:left;font-family:'Courier New',monospace;font-weight:600;font-size:7.5px;letter-spacing:0.1em;">MKT CAP</th>
            <th style="padding:5px 8px;text-align:left;font-family:'Courier New',monospace;font-weight:600;font-size:7.5px;letter-spacing:0.1em;">P/E (TTM)</th>
            <th style="padding:5px 8px;text-align:left;font-family:'Courier New',monospace;font-weight:600;font-size:7.5px;letter-spacing:0.1em;">FWD P/E</th>
            <th style="padding:5px 8px;text-align:left;font-family:'Courier New',monospace;font-weight:600;font-size:7.5px;letter-spacing:0.1em;">REV GROWTH</th>
            <th style="padding:5px 8px;text-align:left;font-family:'Courier New',monospace;font-weight:600;font-size:7.5px;letter-spacing:0.1em;">NET MARGIN</th>
            <th style="padding:5px 8px;text-align:left;font-family:'Courier New',monospace;font-weight:600;font-size:7.5px;letter-spacing:0.1em;">BETA</th>
            <th style="padding:5px 8px;text-align:left;font-family:'Courier New',monospace;font-weight:600;font-size:7.5px;letter-spacing:0.1em;">52W RANGE</th>
          </tr>
          <tr style="background:#f9f9f9;">
            <td style="padding:6px 8px;font-weight:700;">${data.currentPrice ? '$'+data.currentPrice.toFixed(2) : 'N/A'}<br><span style="font-size:8px;color:${data.change1d>=0?'#1a6b1a':'#8a0000'}">${data.change1d?(data.change1d*100).toFixed(2)+'%':''}</span></td>
            <td style="padding:6px 8px;">${formatLargeNumber(data.marketCap)}</td>
            <td style="padding:6px 8px;">${data.peRatio?data.peRatio.toFixed(1)+'x':'N/A'}</td>
            <td style="padding:6px 8px;">${data.forwardPE?data.forwardPE.toFixed(1)+'x':'N/A'}</td>
            <td style="padding:6px 8px;color:${data.revenueGrowth>=0?'#1a6b1a':'#8a0000'};font-weight:600;">${data.revenueGrowth?pct(data.revenueGrowth):'N/A'}</td>
            <td style="padding:6px 8px;">${data.profitMargins?pct(data.profitMargins):'N/A'}</td>
            <td style="padding:6px 8px;">${data.beta?data.beta.toFixed(2):'N/A'}</td>
            <td style="padding:6px 8px;font-size:9px;">$${data.fiftyTwoWeekLow?.toFixed(0)||'?'} – $${data.fiftyTwoWeekHigh?.toFixed(0)||'?'}</td>
          </tr>
        </table>
      </div>

      <!-- SECTION: VALUATION -->
      <div style="margin-bottom:12px;">
        <div style="font-size:7.5px;letter-spacing:0.2em;text-transform:uppercase;color:#0a1628;font-family:'Courier New',monospace;border-bottom:1px solid #0a1628;padding-bottom:4px;margin-bottom:10px;font-weight:700;">VALUATION ANALYSIS</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:#ddd;border:1px solid #ddd;margin-bottom:10px;">
          <div style="background:#f0fff4;padding:10px;text-align:center;">
            <div style="font-size:7.5px;color:#1a6b1a;font-family:'Courier New',monospace;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:4px;">Bull Case</div>
            <div style="font-size:18px;font-weight:700;color:#1a6b1a;">$${dcf.bull_case_price.toFixed(0)}</div>
            <div style="font-size:8px;color:#2d7a2d;margin-top:2px;">${data.currentPrice?((dcf.bull_case_price/data.currentPrice-1)*100).toFixed(0)+'% upside':''}</div>
          </div>
          <div style="background:#fffbf0;padding:10px;text-align:center;">
            <div style="font-size:7.5px;color:#8a6a00;font-family:'Courier New',monospace;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:4px;">Base Case</div>
            <div style="font-size:18px;font-weight:700;color:#7a5a00;">$${dcf.base_case_price.toFixed(0)}</div>
            <div style="font-size:8px;color:#8a6a00;margin-top:2px;">${data.currentPrice?((dcf.base_case_price/data.currentPrice-1)*100).toFixed(0)+'% vs current':''}</div>
          </div>
          <div style="background:#fff5f5;padding:10px;text-align:center;">
            <div style="font-size:7.5px;color:#8a0000;font-family:'Courier New',monospace;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:4px;">Bear Case</div>
            <div style="font-size:18px;font-weight:700;color:#7a0000;">$${dcf.bear_case_price.toFixed(0)}</div>
            <div style="font-size:8px;color:#8a0000;margin-top:2px;">${data.currentPrice?((dcf.bear_case_price/data.currentPrice-1)*100).toFixed(0)+'% downside':''}</div>
          </div>
        </div>
        <div style="font-size:10px;color:#444;line-height:1.65;background:#f9f9f9;padding:10px;border-left:3px solid #0a1628;">${ai.valuation_take}</div>
      </div>

      <!-- SECTION: REWARD vs RISK -->
      <div style="margin-bottom:12px;">
        <div style="font-size:7.5px;letter-spacing:0.2em;text-transform:uppercase;color:#0a1628;font-family:'Courier New',monospace;border-bottom:1px solid #0a1628;padding-bottom:4px;margin-bottom:10px;font-weight:700;">REWARD VS. RISK</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div>
            <div style="font-size:7.5px;color:#1a6b1a;font-family:'Courier New',monospace;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;font-weight:700;">▲ UPSIDE DRIVERS</div>
            ${ai.reward_factors.map(f => `
              <div style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #f0f0f0;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;">
                  <span style="font-weight:700;font-size:10px;">${f.name}</span>
                  <span style="font-family:'Courier New',monospace;font-size:9px;color:#1a6b1a;font-weight:700;">${f.score}/10</span>
                </div>
                <div style="height:3px;background:#e8e8e8;border-radius:1px;margin-bottom:4px;"><div style="height:100%;width:${f.score*10}%;background:#2d7a2d;border-radius:1px;"></div></div>
                <div style="font-size:9px;color:#555;line-height:1.5;">${f.detail}</div>
              </div>
            `).join('')}
          </div>
          <div>
            <div style="font-size:7.5px;color:#8a0000;font-family:'Courier New',monospace;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;font-weight:700;">▼ RISK FACTORS</div>
            ${ai.risk_factors.map(f => `
              <div style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #f0f0f0;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;">
                  <span style="font-weight:700;font-size:10px;">${f.name}</span>
                  <span style="font-family:'Courier New',monospace;font-size:9px;color:#8a0000;font-weight:700;">${f.score}/10</span>
                </div>
                <div style="height:3px;background:#e8e8e8;border-radius:1px;margin-bottom:4px;"><div style="height:100%;width:${f.score*10}%;background:#a01a1a;border-radius:1px;"></div></div>
                <div style="font-size:9px;color:#555;line-height:1.5;">${f.detail}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>

      <!-- SECTION: MACRO + BEAR CASE -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
        <div>
          <div style="font-size:7.5px;letter-spacing:0.2em;text-transform:uppercase;color:#0a1628;font-family:'Courier New',monospace;border-bottom:1px solid #0a1628;padding-bottom:4px;margin-bottom:10px;font-weight:700;">MACRO &amp; RATE CONTEXT</div>
          <div style="background:#f9f9f9;padding:10px;border:1px solid #e0e0e0;">
            <div style="display:flex;gap:16px;margin-bottom:8px;">
              <div style="text-align:center;">
                <div style="font-size:7px;color:#888;font-family:'Courier New',monospace;text-transform:uppercase;margin-bottom:2px;">Rate Sensitivity</div>
                <div style="font-size:13px;font-weight:700;color:#0a1628;">${ai.macro_context.rate_sensitivity}</div>
              </div>
              <div style="text-align:center;">
                <div style="font-size:7px;color:#888;font-family:'Courier New',monospace;text-transform:uppercase;margin-bottom:2px;">Rate Impact</div>
                <div style="font-size:13px;font-weight:700;color:${ai.macro_context.rate_impact==='POSITIVE'?'#1a6b1a':ai.macro_context.rate_impact==='NEGATIVE'?'#8a0000':'#8a6a00'}">${ai.macro_context.rate_impact}</div>
              </div>
            </div>
            <div style="font-size:9px;color:#444;line-height:1.55;border-top:1px solid #e0e0e0;padding-top:8px;">${ai.macro_context.rate_note}</div>
            <div style="font-size:9px;color:#444;line-height:1.55;margin-top:6px;">${ai.macro_sensitivity}</div>
          </div>
        </div>
        <div>
          <div style="font-size:7.5px;letter-spacing:0.2em;text-transform:uppercase;color:#8a0000;font-family:'Courier New',monospace;border-bottom:1px solid #8a0000;padding-bottom:4px;margin-bottom:10px;font-weight:700;">BEAR CASE — WHAT COULD GO WRONG</div>
          <div style="background:#fff5f5;padding:10px;border:1px solid #f0d0d0;border-left:3px solid #8a0000;">
            <div style="font-size:10px;color:#444;line-height:1.65;">${ai.what_could_go_wrong}</div>
          </div>
        </div>
      </div>

      <!-- SECTION: PLAIN ENGLISH -->
      <div style="margin-bottom:12px;">
        <div style="font-size:7.5px;letter-spacing:0.2em;text-transform:uppercase;color:#0a1628;font-family:'Courier New',monospace;border-bottom:1px solid #0a1628;padding-bottom:4px;margin-bottom:10px;font-weight:700;">PLAIN ENGLISH SUMMARY</div>
        <div style="background:#f0f4ff;border-left:4px solid #0a1628;padding:14px 16px;">
          <div style="font-size:11px;font-style:italic;color:#222;line-height:1.7;">${ai.plain_english}</div>
        </div>
      </div>

      <!-- FOOTER -->
      <div style="padding-top:12px;border-top:2px solid #0a1628;display:flex;justify-content:space-between;align-items:center;">
        <div style="font-size:7.5px;color:#888;font-family:'Courier New',monospace;line-height:1.6;">
          CLARITY · AI-POWERED EQUITY RESEARCH<br>
          This report is for educational purposes only. Not financial advice. Not an offer to buy or sell securities.
        </div>
        <div style="text-align:right;">
          <div style="font-size:7.5px;color:#888;font-family:'Courier New',monospace;">tyjwhite42.github.io/clarity</div>
          <div style="font-size:7.5px;color:#888;font-family:'Courier New',monospace;margin-top:2px;">${reportDate}</div>
        </div>
      </div>

    </div>
    </div>`;

    document.body.appendChild(pdfBlock);

    // Animate bars
    setTimeout(() => {
      document.querySelectorAll('.rr-bar-fill').forEach(bar => {
        bar.style.width = bar.dataset.width;
      });
    }, 200);

    results.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
</script>
</body>
</html>
