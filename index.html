<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clarity — Equity Research for Everyone</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: #2a2a3d;
    --accent: #c8f04a;
    --accent2: #4af0c8;
    --danger: #f04a6e;
    --text: #e8e8f0;
    --muted: #6b6b8a;
    --gold: #f0c84a;
  }

  html { scroll-behavior: smooth; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(200,240,74,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(200,240,74,0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  /* Glow orbs */
  .orb {
    position: fixed;
    border-radius: 50%;
    filter: blur(120px);
    pointer-events: none;
    z-index: 0;
    opacity: 0.15;
  }
  .orb-1 { width: 600px; height: 600px; background: var(--accent); top: -200px; right: -200px; animation: float1 8s ease-in-out infinite; }
  .orb-2 { width: 400px; height: 400px; background: var(--accent2); bottom: 100px; left: -100px; animation: float2 10s ease-in-out infinite; }

  @keyframes float1 { 0%,100% { transform: translate(0,0); } 50% { transform: translate(-30px, 40px); } }
  @keyframes float2 { 0%,100% { transform: translate(0,0); } 50% { transform: translate(20px, -30px); } }

  /* Nav */
  nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    padding: 20px 48px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(10,10,15,0.8);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: 900;
    letter-spacing: -0.02em;
    color: var(--text);
  }
  .logo span { color: var(--accent); }

  .nav-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  /* Hero */
  .hero {
    position: relative;
    z-index: 1;
    padding: 180px 48px 80px;
    max-width: 1100px;
    margin: 0 auto;
  }

  .hero-eyebrow {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .hero-eyebrow::before {
    content: '';
    display: block;
    width: 32px;
    height: 1px;
    background: var(--accent);
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(3rem, 6vw, 5.5rem);
    font-weight: 900;
    line-height: 1.05;
    letter-spacing: -0.03em;
    margin-bottom: 28px;
  }
  h1 em {
    font-style: italic;
    color: var(--accent);
  }

  .hero-sub {
    font-size: 1.1rem;
    color: var(--muted);
    max-width: 540px;
    line-height: 1.7;
    margin-bottom: 56px;
    font-weight: 300;
  }

  /* Search bar */
  .search-wrapper {
    display: flex;
    gap: 0;
    max-width: 600px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .search-wrapper:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(200,240,74,0.1);
  }

  .ticker-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    padding: 0 16px;
    display: flex;
    align-items: center;
    border-right: 1px solid var(--border);
    white-space: nowrap;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  #ticker-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    padding: 18px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 1.1rem;
    color: var(--text);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  #ticker-input::placeholder { color: var(--muted); text-transform: none; letter-spacing: 0; font-size: 0.95rem; }

  .analyze-btn {
    background: var(--accent);
    color: #0a0a0f;
    border: none;
    padding: 18px 28px;
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    white-space: nowrap;
  }
  .analyze-btn:hover { background: #d9ff55; }
  .analyze-btn:active { transform: scale(0.98); }
  .analyze-btn:disabled { background: var(--muted); cursor: not-allowed; }

  .quick-picks {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .quick-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .quick-chip {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    padding: 5px 12px;
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.08em;
    background: transparent;
  }
  .quick-chip:hover { border-color: var(--accent); color: var(--accent); }

  /* Results */
  #results {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 48px 80px;
    display: none;
  }

  .divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
    margin-bottom: 48px;
  }

  /* Stock header */
  .stock-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 40px;
    flex-wrap: wrap;
    gap: 24px;
  }

  .stock-name-block .ticker {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.2em;
    color: var(--accent);
    margin-bottom: 6px;
    text-transform: uppercase;
  }
  .stock-name-block h2 {
    font-family: 'Playfair Display', serif;
    font-size: 2.4rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }
  .stock-name-block .sector-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-top: 6px;
  }

  /* Conviction score */
  .conviction-block {
    text-align: right;
  }
  .conviction-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  .conviction-score {
    font-family: 'Playfair Display', serif;
    font-size: 4rem;
    font-weight: 900;
    line-height: 1;
    color: var(--accent);
  }
  .conviction-score.medium { color: var(--gold); }
  .conviction-score.low { color: var(--danger); }
  .conviction-verdict {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-top: 4px;
  }

  /* Key metrics bar */
  .metrics-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1px;
    background: var(--border);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 40px;
  }
  .metric-cell {
    background: var(--surface);
    padding: 20px 24px;
    transition: background 0.2s;
  }
  .metric-cell:hover { background: var(--surface2); }
  .metric-name {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  .metric-value {
    font-family: 'DM Mono', monospace;
    font-size: 1.2rem;
    font-weight: 500;
    color: var(--text);
  }
  .metric-value.positive { color: var(--accent); }
  .metric-value.negative { color: var(--danger); }
  .metric-delta {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    margin-top: 4px;
  }

  /* Analysis grid */
  .analysis-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  @media (max-width: 768px) {
    .analysis-grid { grid-template-columns: 1fr; }
    nav { padding: 16px 24px; }
    .hero, #results { padding-left: 24px; padding-right: 24px; }
    h1 { font-size: 2.5rem; }
    .stock-header { flex-direction: column; }
    .conviction-block { text-align: left; }
  }

  .analysis-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 28px;
    transition: border-color 0.2s;
    animation: fadeUp 0.5s ease forwards;
    opacity: 0;
  }
  .analysis-card:hover { border-color: rgba(200,240,74,0.3); }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .card-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-label.danger { color: var(--danger); }
  .card-label.gold { color: var(--gold); }
  .card-label.teal { color: var(--accent2); }

  .card-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .card-content {
    font-size: 0.92rem;
    line-height: 1.75;
    color: #b8b8cc;
    font-weight: 300;
  }

  /* Risk/reward bars */
  .rr-item {
    margin-bottom: 20px;
  }
  .rr-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  .rr-name {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    color: var(--text);
  }
  .rr-score {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--muted);
  }
  .rr-bar-bg {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .rr-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .fill-reward { background: var(--accent); }
  .fill-risk { background: var(--danger); }
  .fill-neutral { background: var(--gold); }

  /* Plain English section */
  .plain-english {
    grid-column: 1 / -1;
    background: var(--surface);
    border: 1px solid var(--accent);
    border-radius: 4px;
    padding: 28px;
    animation: fadeUp 0.5s ease 0.3s forwards;
    opacity: 0;
  }

  .pe-quote {
    font-family: 'Playfair Display', serif;
    font-size: 1.05rem;
    font-style: italic;
    line-height: 1.7;
    color: var(--text);
    border-left: 3px solid var(--accent);
    padding-left: 20px;
    margin-top: 16px;
  }

  /* Macro context */
  .macro-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 20px 28px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 24px;
    flex-wrap: wrap;
    animation: fadeUp 0.5s ease 0.1s forwards;
    opacity: 0;
  }
  .macro-item {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .macro-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .macro-text {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    letter-spacing: 0.05em;
  }
  .macro-text strong {
    color: var(--text);
    font-weight: 500;
  }

  /* Loading */
  .loading {
    display: none;
    text-align: center;
    padding: 60px 0;
  }
  .loading-ring {
    width: 48px;
    height: 48px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 20px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }
  .loading-steps {
    margin-top: 12px;
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
  }

  /* Footer note */
  .disclaimer {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    text-align: center;
    padding: 24px 48px;
    border-top: 1px solid var(--border);
    letter-spacing: 0.05em;
    position: relative;
    z-index: 1;
  }

  /* Stagger animation delays */
  .analysis-card:nth-child(1) { animation-delay: 0.1s; }
  .analysis-card:nth-child(2) { animation-delay: 0.2s; }
  .analysis-card:nth-child(3) { animation-delay: 0.25s; }
  .analysis-card:nth-child(4) { animation-delay: 0.3s; }

  /* Error state */
  .error-msg {
    background: rgba(240,74,110,0.08);
    border: 1px solid var(--danger);
    border-radius: 4px;
    padding: 16px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--danger);
    display: none;
    margin-top: 12px;
  }
</style>
</head>
<body>

<!-- API Key Setup Banner -->
<div id="api-setup" style="display:none; position:fixed; inset:0; z-index:999; background:rgba(10,10,15,0.97); backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center; flex-direction:column; padding:24px;">
  <div style="max-width:480px; width:100%; background:#12121a; border:1px solid #2a2a3d; border-radius:6px; padding:40px;">
    <div style="font-family:'DM Mono',monospace; font-size:0.65rem; letter-spacing:0.2em; text-transform:uppercase; color:#c8f04a; margin-bottom:16px;">First Time Setup</div>
    <div style="font-family:'Playfair Display',serif; font-size:1.8rem; font-weight:700; color:#e8e8f0; margin-bottom:12px;">Enter your API Key</div>
    <div style="font-family:'DM Sans',sans-serif; font-size:0.88rem; color:#6b6b8a; line-height:1.6; margin-bottom:28px;">
      Paste your Anthropic API key below. It will be saved on your computer and you'll never need to enter it again.
    </div>
    <input 
      type="password" 
      id="api-key-input"
      placeholder="sk-ant-api03-..."
      style="width:100%; background:#0a0a0f; border:1px solid #2a2a3d; border-radius:4px; padding:14px 16px; font-family:'DM Mono',monospace; font-size:0.85rem; color:#e8e8f0; outline:none; margin-bottom:12px;"
    />
    <div id="api-error" style="color:#f04a6e; font-family:'DM Mono',monospace; font-size:0.72rem; margin-bottom:12px; display:none;">Please enter a valid API key (starts with sk-ant-)</div>
    <button onclick="saveApiKey()" style="width:100%; background:#c8f04a; color:#0a0a0f; border:none; padding:14px; font-family:'DM Mono',monospace; font-size:0.8rem; font-weight:500; letter-spacing:0.12em; text-transform:uppercase; cursor:pointer; border-radius:4px;">
      Save & Continue →
    </button>
    <div style="font-family:'DM Mono',monospace; font-size:0.65rem; color:#6b6b8a; margin-top:16px; text-align:center;">
      Your key is stored locally on your Mac only. Never shared.
    </div>
  </div>
</div>

<div class="orb orb-1"></div>
<div class="orb orb-2"></div>

<nav>
  <div class="logo">Clarity<span>.</span></div>
  <div class="nav-tag">Equity Research — Democratized</div>
</nav>

<section class="hero">
  <div class="hero-eyebrow">AI-Powered Stock Analysis</div>
  <h1>Wall Street research.<br><em>For everyone.</em></h1>
  <p class="hero-sub">Enter any stock ticker and get the same quality of analysis that hedge funds pay thousands for — in plain English and in analyst-grade detail. Reward vs. risk, front and center.</p>

  <div class="search-wrapper">
    <div class="ticker-label">Ticker</div>
    <input type="text" id="ticker-input" placeholder="e.g. AAPL, NVDA, TSLA" maxlength="10" />
    <button class="analyze-btn" id="analyze-btn" onclick="runAnalysis()">Analyze →</button>
  </div>
  <div class="error-msg" id="error-msg"></div>

  <div class="quick-picks">
    <span class="quick-label">Try:</span>
    <button class="quick-chip" onclick="quickPick('AAPL')">AAPL</button>
    <button class="quick-chip" onclick="quickPick('NVDA')">NVDA</button>
    <button class="quick-chip" onclick="quickPick('MSFT')">MSFT</button>
    <button class="quick-chip" onclick="quickPick('TSLA')">TSLA</button>
    <button class="quick-chip" onclick="quickPick('AMZN')">AMZN</button>
  </div>
</section>

<!-- Loading -->
<div class="loading" id="loading">
  <div class="loading-ring"></div>
  <div class="loading-text">Pulling financial data</div>
  <div class="loading-steps" id="loading-step">Fetching price & valuation metrics...</div>
</div>

<!-- Results -->
<div id="results">
  <div class="divider"></div>

  <!-- Stock header -->
  <div class="stock-header">
    <div class="stock-name-block">
      <div class="ticker" id="res-ticker"></div>
      <h2 id="res-name"></h2>
      <div class="sector-tag" id="res-sector"></div>
    </div>
    <div class="conviction-block">
      <div class="conviction-label">AI Conviction Score</div>
      <div class="conviction-score" id="res-conviction"></div>
      <div class="conviction-verdict" id="res-verdict"></div>
    </div>
  </div>

  <!-- Metrics bar -->
  <div class="metrics-bar" id="metrics-bar"></div>

  <!-- Macro context -->
  <div class="macro-bar" id="macro-bar"></div>

  <!-- Analysis grid -->
  <div class="analysis-grid" id="analysis-grid"></div>
</div>

<div class="disclaimer">
  Clarity is an educational tool built for learning purposes. Not financial advice. Always do your own research before investing.
</div>

<script>
  let ANTHROPIC_API_KEY = localStorage.getItem('clarity_api_key') || '';

  // Show setup screen if no key saved
  window.addEventListener('DOMContentLoaded', () => {
    if (!ANTHROPIC_API_KEY) {
      document.getElementById('api-setup').style.display = 'flex';
    }
  });

  function saveApiKey() {
    const key = document.getElementById('api-key-input').value.trim();
    const errEl = document.getElementById('api-error');
    if (!key.startsWith('sk-ant-')) {
      errEl.style.display = 'block';
      return;
    }
    errEl.style.display = 'none';
    ANTHROPIC_API_KEY = key;
    localStorage.setItem('clarity_api_key', key);
    document.getElementById('api-setup').style.display = 'none';
  }

  function quickPick(ticker) {
    document.getElementById('ticker-input').value = ticker;
    runAnalysis();
  }

  document.getElementById('ticker-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') runAnalysis();
  });

  function setLoadingStep(text) {
    document.getElementById('loading-step').textContent = text;
  }

  async function runAnalysis() {
    const ticker = document.getElementById('ticker-input').value.trim().toUpperCase();
    if (!ticker) return;

    const errEl = document.getElementById('error-msg');
    errEl.style.display = 'none';
    document.getElementById('results').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    document.getElementById('analyze-btn').disabled = true;

    try {
      setLoadingStep('Fetching price & valuation metrics...');
      await sleep(400);

      // Fetch stock data from Yahoo Finance via a CORS proxy
      const yahooData = await fetchStockData(ticker);
      
      setLoadingStep('Running macro context analysis...');
      await sleep(400);

      setLoadingStep('Generating AI analyst report...');
      const analysis = await generateAnalysis(ticker, yahooData);

      setLoadingStep('Building your report...');
      await sleep(300);

      renderResults(ticker, yahooData, analysis);

    } catch (err) {
      document.getElementById('loading').style.display = 'none';
      errEl.textContent = err.message || 'Something went wrong. Please try again.';
      errEl.style.display = 'block';
    } finally {
      document.getElementById('analyze-btn').disabled = false;
    }
  }

  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  async function fetchStockData(ticker) {
    // Use Claude to fetch and return real financial data for the ticker
    const prompt = `You are a financial data API. Return current, accurate financial data for the stock ticker "${ticker}". 
Use your knowledge of this company's most recent publicly available financials.
If the ticker is invalid or unknown, set "valid" to false.

Return ONLY valid JSON, no markdown, no explanation:
{
  "valid": true,
  "name": "Full Company Name",
  "sector": "Sector",
  "industry": "Industry",
  "description": "2 sentence company description",
  "currentPrice": 150.00,
  "change1d": 0.012,
  "marketCap": 2400000000000,
  "peRatio": 28.5,
  "forwardPE": 24.0,
  "pbRatio": 8.2,
  "psRatio": 6.5,
  "beta": 1.2,
  "fiftyTwoWeekHigh": 200.00,
  "fiftyTwoWeekLow": 130.00,
  "revenueGrowth": 0.08,
  "earningsGrowth": 0.12,
  "profitMargins": 0.25,
  "returnOnEquity": 0.45,
  "debtToEquity": 150.0,
  "currentRatio": 1.2,
  "freeCashflow": 90000000000,
  "targetMeanPrice": 210.00,
  "recommendationKey": "buy"
}`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 600,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error('API error: ' + (err.error?.message || 'Check your API key and try again.'));
    }

    const result = await response.json();
    const text = result.content[0].text.replace(/```json|```/g, '').trim();
    const data = JSON.parse(text);

    if (!data.valid) throw new Error(`Ticker "${ticker}" not found. Please check and try again.`);
    return data;
  }

  async function generateAnalysis(ticker, data) {
    const prompt = `You are a senior equity research analyst. Analyze the following stock data for ${ticker} (${data.name}) and produce a structured JSON analysis report. Be direct, data-driven, and honest about both upside and downside.

STOCK DATA:
- Company: ${data.name}
- Sector: ${data.sector} / ${data.industry}
- Current Price: $${data.currentPrice?.toFixed(2)}
- 1-Day Change: ${(data.change1d * 100)?.toFixed(2)}%
- Market Cap: $${formatLargeNumber(data.marketCap)}
- P/E Ratio (TTM): ${data.peRatio?.toFixed(1) || 'N/A'}
- Forward P/E: ${data.forwardPE?.toFixed(1) || 'N/A'}
- Price/Book: ${data.pbRatio?.toFixed(2) || 'N/A'}
- Price/Sales: ${data.psRatio?.toFixed(2) || 'N/A'}
- Beta: ${data.beta?.toFixed(2) || 'N/A'}
- Revenue Growth (YoY): ${data.revenueGrowth ? (data.revenueGrowth * 100).toFixed(1) + '%' : 'N/A'}
- Earnings Growth (YoY): ${data.earningsGrowth ? (data.earningsGrowth * 100).toFixed(1) + '%' : 'N/A'}
- Profit Margin: ${data.profitMargins ? (data.profitMargins * 100).toFixed(1) + '%' : 'N/A'}
- Return on Equity: ${data.returnOnEquity ? (data.returnOnEquity * 100).toFixed(1) + '%' : 'N/A'}
- Debt/Equity: ${data.debtToEquity?.toFixed(2) || 'N/A'}
- Analyst Target Price: $${data.targetMeanPrice?.toFixed(2) || 'N/A'}
- Analyst Recommendation: ${data.recommendationKey || 'N/A'}
- 52-Week Range: $${data.fiftyTwoWeekLow?.toFixed(2)} - $${data.fiftyTwoWeekHigh?.toFixed(2)}
- Business: ${data.description?.substring(0, 400)}

Return ONLY valid JSON with this exact structure (no markdown, no explanation):
{
  "conviction_score": <integer 1-10>,
  "verdict": <"STRONG BUY" | "BUY" | "HOLD" | "SELL" | "STRONG SELL">,
  "analyst_summary": <2-3 sentence professional summary>,
  "plain_english": <2-3 sentence explanation a first-time investor would understand, starting with what the company does, then whether it's a good deal>,
  "reward_factors": [
    {"name": <string>, "score": <1-10>, "detail": <one sentence>},
    {"name": <string>, "score": <1-10>, "detail": <one sentence>},
    {"name": <string>, "score": <1-10>, "detail": <one sentence>}
  ],
  "risk_factors": [
    {"name": <string>, "score": <1-10, where 10 = highest risk>, "detail": <one sentence>},
    {"name": <string>, "score": <1-10>, "detail": <one sentence>},
    {"name": <string>, "score": <1-10>, "detail": <one sentence>}
  ],
  "valuation_take": <2 sentences on whether the stock is cheap, fairly valued, or expensive>,
  "macro_sensitivity": <1 sentence on how interest rates / macro environment affects this stock>,
  "what_could_go_wrong": <2 sentences on the biggest bear case, be specific>,
  "macro_context": {
    "rate_sensitivity": <"HIGH" | "MEDIUM" | "LOW">,
    "rate_impact": <"POSITIVE" | "NEGATIVE" | "NEUTRAL">,
    "rate_note": <short note on rate sensitivity>
  }
}`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1200,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error('AI analysis failed: ' + (err.error?.message || 'Unknown error'));
    }

    const result = await response.json();
    const text = result.content[0].text.replace(/```json|```/g, '').trim();
    return JSON.parse(text);
  }

  function formatLargeNumber(n) {
    if (!n) return 'N/A';
    if (n >= 1e12) return (n / 1e12).toFixed(2) + 'T';
    if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
    return n.toFixed(0);
  }

  function pct(val) {
    if (val == null) return 'N/A';
    return (val * 100).toFixed(1) + '%';
  }

  function renderResults(ticker, data, ai) {
    document.getElementById('loading').style.display = 'none';
    const results = document.getElementById('results');
    results.style.display = 'block';

    // Header
    document.getElementById('res-ticker').textContent = ticker;
    document.getElementById('res-name').textContent = data.name;
    document.getElementById('res-sector').textContent = `${data.sector} · ${data.industry}`;

    // Conviction
    const convEl = document.getElementById('res-conviction');
    convEl.textContent = ai.conviction_score + '/10';
    convEl.className = 'conviction-score';
    if (ai.conviction_score >= 7) convEl.classList.add(''); // green default
    else if (ai.conviction_score >= 5) convEl.classList.add('medium');
    else convEl.classList.add('low');
    document.getElementById('res-verdict').textContent = ai.verdict;

    // Metrics bar
    const metrics = [
      { name: 'Price', value: data.currentPrice ? `$${data.currentPrice.toFixed(2)}` : 'N/A', delta: data.change1d ? `${(data.change1d*100).toFixed(2)}% today` : '', cls: data.change1d >= 0 ? 'positive' : 'negative' },
      { name: 'Market Cap', value: formatLargeNumber(data.marketCap), delta: data.sector || '' },
      { name: 'P/E Ratio', value: data.peRatio ? data.peRatio.toFixed(1) + 'x' : 'N/A', delta: `Fwd: ${data.forwardPE ? data.forwardPE.toFixed(1) + 'x' : 'N/A'}` },
      { name: 'Revenue Growth', value: data.revenueGrowth ? pct(data.revenueGrowth) : 'N/A', cls: data.revenueGrowth > 0 ? 'positive' : 'negative' },
      { name: 'Profit Margin', value: data.profitMargins ? pct(data.profitMargins) : 'N/A', cls: data.profitMargins > 0.15 ? 'positive' : '' },
      { name: 'Beta', value: data.beta ? data.beta.toFixed(2) : 'N/A', delta: 'vs market' },
      { name: 'Analyst Target', value: data.targetMeanPrice ? `$${data.targetMeanPrice.toFixed(2)}` : 'N/A', cls: data.targetMeanPrice > data.currentPrice ? 'positive' : 'negative' },
      { name: '52W Range', value: `$${data.fiftyTwoWeekLow?.toFixed(0)}–$${data.fiftyTwoWeekHigh?.toFixed(0)}`, delta: '' },
    ];

    document.getElementById('metrics-bar').innerHTML = metrics.map(m => `
      <div class="metric-cell">
        <div class="metric-name">${m.name}</div>
        <div class="metric-value ${m.cls || ''}">${m.value}</div>
        ${m.delta ? `<div class="metric-delta">${m.delta}</div>` : ''}
      </div>
    `).join('');

    // Macro bar
    const mc = ai.macro_context;
    const rateColor = mc.rate_impact === 'POSITIVE' ? '#c8f04a' : mc.rate_impact === 'NEGATIVE' ? '#f04a6e' : '#f0c84a';
    document.getElementById('macro-bar').innerHTML = `
      <div class="macro-item">
        <div class="macro-dot" style="background:#6b6b8a"></div>
        <div class="macro-text"><strong>Macro Overlay</strong></div>
      </div>
      <div class="macro-item">
        <div class="macro-dot" style="background:${rateColor}"></div>
        <div class="macro-text">Rate Sensitivity: <strong>${mc.rate_sensitivity}</strong></div>
      </div>
      <div class="macro-item">
        <div class="macro-dot" style="background:${rateColor}"></div>
        <div class="macro-text">Rate Impact: <strong>${mc.rate_impact}</strong></div>
      </div>
      <div class="macro-item" style="flex:1">
        <div class="macro-text" style="color:#8888aa">${mc.rate_note}</div>
      </div>
    `;

    // Analysis grid
    const grid = document.getElementById('analysis-grid');
    grid.innerHTML = '';

    // Reward card
    const rewardCard = document.createElement('div');
    rewardCard.className = 'analysis-card';
    rewardCard.innerHTML = `
      <div class="card-label">Reward Factors</div>
      ${ai.reward_factors.map(f => `
        <div class="rr-item">
          <div class="rr-header">
            <span class="rr-name">${f.name}</span>
            <span class="rr-score">${f.score}/10</span>
          </div>
          <div class="rr-bar-bg"><div class="rr-bar-fill fill-reward" style="width:0%" data-width="${f.score * 10}%"></div></div>
          <div style="font-size:0.78rem;color:var(--muted);margin-top:6px;font-weight:300">${f.detail}</div>
        </div>
      `).join('')}
    `;
    grid.appendChild(rewardCard);

    // Risk card
    const riskCard = document.createElement('div');
    riskCard.className = 'analysis-card';
    riskCard.innerHTML = `
      <div class="card-label danger">Risk Factors</div>
      ${ai.risk_factors.map(f => `
        <div class="rr-item">
          <div class="rr-header">
            <span class="rr-name">${f.name}</span>
            <span class="rr-score">${f.score}/10</span>
          </div>
          <div class="rr-bar-bg"><div class="rr-bar-fill fill-risk" style="width:0%" data-width="${f.score * 10}%"></div></div>
          <div style="font-size:0.78rem;color:var(--muted);margin-top:6px;font-weight:300">${f.detail}</div>
        </div>
      `).join('')}
    `;
    grid.appendChild(riskCard);

    // Valuation card
    const valCard = document.createElement('div');
    valCard.className = 'analysis-card';
    valCard.innerHTML = `
      <div class="card-label gold">Valuation Analysis</div>
      <div class="card-content">${ai.valuation_take}</div>
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
        <div class="card-label" style="font-size:0.6rem;color:var(--muted);margin-bottom:8px">BEAR CASE — WHAT COULD GO WRONG</div>
        <div class="card-content" style="color:#aa8888">${ai.what_could_go_wrong}</div>
      </div>
    `;
    grid.appendChild(valCard);

    // Analyst summary
    const summaryCard = document.createElement('div');
    summaryCard.className = 'analysis-card';
    summaryCard.innerHTML = `
      <div class="card-label teal">Analyst Summary</div>
      <div class="card-content">${ai.analyst_summary}</div>
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
        <div class="card-label" style="font-size:0.6rem;color:var(--muted);margin-bottom:8px">MACRO SENSITIVITY</div>
        <div class="card-content">${ai.macro_sensitivity}</div>
      </div>
    `;
    grid.appendChild(summaryCard);

    // Plain English (full width)
    const peCard = document.createElement('div');
    peCard.className = 'plain-english';
    peCard.innerHTML = `
      <div class="card-label">Plain English — For Every Investor</div>
      <div class="pe-quote">${ai.plain_english}</div>
    `;
    grid.appendChild(peCard);

    // Animate bars after render
    setTimeout(() => {
      document.querySelectorAll('.rr-bar-fill').forEach(bar => {
        bar.style.width = bar.dataset.width;
      });
    }, 200);

    results.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
</script>
</body>
</html>
